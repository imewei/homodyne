name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  PYTHONDONTWRITEBYTECODE: 1
  PYTHONUNBUFFERED: 1

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install linters
        run: |
          pip install --upgrade pip
          pip install "ruff>=0.13.3" "black>=25.9.0"

      - name: Check formatting
        run: |
          ruff format --check homodyne/ tests/
          black --check --diff homodyne/ tests/

      - name: Lint code
        run: ruff check homodyne/ tests/ --output-format=github

  test-cpu:
    name: Test CPU (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        # Test all platforms with Python 3.12
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies (CPU-only)
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Verify JAX installation
        run: |
          python -c "import jax; print(f'JAX version: {jax.__version__}'); print(f'JAX devices: {jax.devices()}')"

      - name: Run unit tests
        run: |
          pytest tests/unit/ \
            -v \
            -n auto \
            --tb=short \
            --maxfail=5 \
            -m "not slow and not gpu" \
            --cov=homodyne \
            --cov-report=xml \
            --cov-report=term

      - name: Run integration tests
        if: matrix.os == 'ubuntu-latest'
        run: |
          pytest tests/integration/ \
            -v \
            -n auto \
            --tb=short \
            -m "not slow and not gpu"

      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          flags: unittests
          fail_ci_if_error: false

  test-gpu:
    name: Test GPU (Linux, Python 3.12)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Note: Requires self-hosted runner with CUDA GPU
    # Disabled by default until GPU runner is available
    if: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install JAX with CUDA support
        run: |
          pip install --upgrade pip
          pip uninstall -y jax jaxlib || true
          pip install jax[cuda12-local]==0.8.0 jaxlib==0.8.0

      - name: Install package
        run: pip install -e ".[dev]"

      - name: Verify GPU availability
        run: |
          python -c "import jax; print(f'JAX devices: {jax.devices()}'); assert any('gpu' in str(d).lower() for d in jax.devices()), 'No GPU found'"

      - name: Run GPU tests
        run: |
          pytest tests/gpu/ \
            -v \
            --tb=short \
            -m gpu

  build:
    name: Build Package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint, test-cpu]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for setuptools_scm

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: |
          pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Test installation
        run: |
          pip install dist/*.whl
          python -c "import homodyne; print(f'Homodyne version: {homodyne.__version__}')"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 7

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint, test-cpu]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[docs]"

      - name: Build docs
        run: |
          cd docs
          make html

      - name: Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/_build/html
