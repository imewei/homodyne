# Migration Guide: v2.2.x → v2.3.0 (GPU Support Removal)

**Breaking Change Type:** Hard break - No migration path provided
**Last GPU-Supporting Version:** v2.2.1
**Rationale:** Simplify maintenance, focus on reliable CPU execution

---

## Executive Summary

Homodyne v2.3.0 removes all GPU acceleration support in favor of a CPU-only architecture. This is a **hard breaking change** with no migration path. Users who require GPU acceleration should remain on **v2.2.1**, the last GPU-supporting version.

**Key Decision:**
- **Need GPU?** → Stay on v2.2.1 (maintained)
- **CPU-only OK?** → Upgrade to v2.3.0 (recommended)

---

## Why Remove GPU Support?

### Technical Rationale

1. **Maintenance Complexity**
   - GPU code paths added 40% more complexity to device management
   - CUDA version conflicts with HPC system installations
   - GPU memory management errors difficult to debug

2. **Reliability Issues**
   - GPU OOM errors with large datasets (>1M points) + per-angle scaling
   - Inconsistent behavior across NVIDIA GPU generations
   - CPU-only mode already provided consistent, predictable results

3. **Focus on Core Strengths**
   - JAX CPU performance excellent for XPCS workflows
   - HPC clusters provide abundant CPU cores (36-128 cores/node)
   - Multi-core CPU parallelization more predictable than GPU memory management

### What Users Should Know

- **v2.2.1 remains available** for GPU users (no forced migration)
- **CPU-only performance** is excellent for XPCS analysis (93%+ cost reduction achieved)
- **HPC multi-core CPU** optimization now the primary focus
- **Simpler codebase** means faster bug fixes and new features

---

## What's Removed in v2.3.0

### 1. Command-Line Interface

#### Removed CLI Flags

| Flag | Purpose | v2.3.0 Alternative |
|------|---------|-------------------|
| `--force-cpu` | Force CPU-only execution | Always CPU-only now |
| `--gpu-memory-fraction` | GPU memory allocation | Not applicable |

#### Before (v2.2.1):
```bash
# Force CPU execution
homodyne --config config.yaml --force-cpu

# Limit GPU memory usage
homodyne --config config.yaml --gpu-memory-fraction 0.7
```

#### After (v2.3.0):
```bash
# All execution is CPU-only (no flags needed)
homodyne --config config.yaml
```

### 2. Configuration Files (YAML)

#### Removed Configuration Keys

| Key | Purpose | v2.3.0 Alternative |
|-----|---------|-------------------|
| `performance.gpu_memory_fraction` | GPU memory limit | Not applicable |
| `performance.force_cpu` | Force CPU execution | Always CPU-only |
| `performance.cuda_device_id` | Select GPU device | Not applicable |

#### Before (v2.2.1):
```yaml
performance:
  force_cpu: false
  gpu_memory_fraction: 0.8
  cuda_device_id: 0
```

#### After (v2.3.0):
```yaml
# No GPU configuration keys - all removed
performance:
  # CPU-focused configuration only
  chunk_size: 100000
  batch_size: 50
```

**Note:** v2.3.0 gracefully ignores legacy GPU keys for backward compatibility with old config files.

### 3. Python API Functions

#### Removed from `homodyne.device`

| Function | Purpose | v2.3.0 Alternative |
|----------|---------|-------------------|
| `configure_system_cuda()` | CUDA initialization | Use `configure_optimal_device()` (CPU-only) |
| `detect_system_cuda()` | CUDA detection | Not applicable |
| `validate_cuda_installation()` | CUDA validation | Not applicable |
| `get_gpu_memory_info()` | GPU memory status | Use `psutil` for CPU memory |
| `optimize_gpu_memory()` | GPU memory optimization | Not applicable |
| `benchmark_gpu_performance()` | GPU benchmarking | Use `benchmark_cpu_performance()` |
| `is_gpu_active()` | GPU status check | Always returns False |
| `switch_to_cpu()` | Force CPU mode | Not applicable (always CPU) |

#### Before (v2.2.1):
```python
from homodyne.device import configure_system_cuda, is_gpu_active

# Configure GPU
cuda_config = configure_system_cuda(memory_fraction=0.8)

# Check GPU status
if is_gpu_active():
    print("Running on GPU")
```

#### After (v2.3.0):
```python
from homodyne.device import configure_optimal_device

# Configure optimal device (CPU-only)
config = configure_optimal_device()
print(f"Device: {config['device_type']}")  # Always 'cpu'
```

### 4. Makefile Targets

#### Removed Targets

| Target | Purpose | v2.3.0 Alternative |
|--------|---------|-------------------|
| `make install-jax-gpu` | Install JAX with GPU support | Use `make dev` (CPU-only) |
| `make gpu-check` | Validate GPU/CUDA setup | Not applicable |
| `make test-gpu` | Run GPU-specific tests | Not applicable |

#### Before (v2.2.1):
```bash
# Install with GPU support
make install-jax-gpu

# Check GPU setup
make gpu-check

# Run GPU tests
make test-gpu
```

#### After (v2.3.0):
```bash
# Install (CPU-only)
make dev

# All tests are CPU-only
make test
```

### 5. Example Files

#### Removed Examples

| File | Purpose | v2.3.0 Alternative |
|------|---------|-------------------|
| `examples/gpu_accelerated_optimization.py` | GPU optimization demo | Use `examples/cpu_optimization.py` |
| `examples/gpu_acceleration.py` | GPU features showcase | Use `examples/multi_core_batch_processing.py` |

#### New CPU-Focused Examples (v2.3.0):
- `examples/cpu_optimization.py` - HPC multi-core CPU usage patterns
- `examples/multi_core_batch_processing.py` - Parallel CPU workflows

### 6. Documentation Files

#### Removed/Deprecated Sphinx Docs

| File | Status | v2.3.0 Alternative |
|------|--------|-------------------|
| `docs/advanced-topics/gpu-acceleration.rst` | **DEPRECATED** | CPU optimization guides |
| GPU sections in installation guide | Removed | CPU-only installation |
| GPU performance benchmarks | Removed | CPU performance guides |

---

## Migration Strategies

### Strategy 1: Stay on v2.2.1 (Recommended for GPU Users)

**Who should use this:**
- Users with GPU-specific workflows
- Users who need maximum single-threaded performance
- Users with established GPU infrastructure

**How to stay on v2.2.1:**
```bash
# Pin to v2.2.1 in requirements.txt
homodyne==2.2.1

# Or install explicitly
pip install homodyne==2.2.1

# Verify version
python -c "import homodyne; print(homodyne.__version__)"
# Should print: 2.2.1
```

**Support Status:**
- **v2.2.1 remains available** on PyPI indefinitely
- Critical bug fixes backported to v2.2.x branch (best effort)
- No new features added to v2.2.x (maintenance only)
- GPU-specific issues may not be prioritized

### Strategy 2: Upgrade to v2.3.0 (Recommended for Most Users)

**Who should use this:**
- Users with HPC multi-core CPU access
- Users experiencing GPU OOM errors
- Users wanting simplified, reliable execution
- Users who value faster bug fixes and new features

**How to upgrade:**

#### Step 1: Install v2.3.0
```bash
pip install --upgrade homodyne
```

#### Step 2: Update Configuration Files

**Remove GPU keys from YAML configs:**
```bash
# Automated cleanup (recommended)
sed -i '/gpu_memory_fraction/d' config.yaml
sed -i '/force_cpu/d' config.yaml
sed -i '/cuda_device_id/d' config.yaml

# Manual: Edit config.yaml and delete GPU lines
```

**Note:** v2.3.0 gracefully ignores unknown GPU keys, so this is optional.

#### Step 3: Update Scripts

**Remove GPU device management:**
```python
# ❌ REMOVE (v2.2.1):
from homodyne.device import configure_system_cuda, is_gpu_active

cuda_config = configure_system_cuda()
if is_gpu_active():
    print("GPU active")

# ✅ USE (v2.3.0):
from homodyne.device import configure_optimal_device

config = configure_optimal_device()
print(f"Running on {config['device_type']}")  # Always 'cpu'
```

#### Step 4: Update Makefile Commands

```bash
# ❌ REMOVE (v2.2.1):
make install-jax-gpu
make gpu-check

# ✅ USE (v2.3.0):
make dev          # CPU-only installation
make test         # CPU-only tests
```

#### Step 5: Verify CPU Performance

```bash
# Run existing workflow
homodyne --config config.yaml

# Check performance (should be excellent with multi-core CPU)
# Example: 3M points, 3 angles → ~150s on 14-core CPU
```

### Strategy 3: Hybrid Approach (Not Recommended)

**Not supported:** Running v2.2.1 and v2.3.0 in parallel is complex and not recommended.

---

## Performance Comparison: GPU vs CPU

### v2.2.1 (GPU) vs v2.3.0 (CPU-only)

| Workload | v2.2.1 GPU | v2.3.0 CPU (14-core) | Notes |
|----------|-----------|---------------------|-------|
| Small dataset (<100k points) | ~5s | ~6s | CPU competitive |
| Medium dataset (1M points) | ~30s | ~45s | CPU 1.5x slower, but reliable |
| Large dataset (3M points) | GPU OOM | ~150s | **CPU succeeds where GPU failed** |
| Per-angle scaling (3M points) | GPU OOM | ~150s | **CPU only reliable solution** |
| MCMC (20 samples) | ~40 min | ~40 min | CPU parallelization competitive |

**Key Takeaway:** CPU-only v2.3.0 provides **reliable, predictable performance** without GPU OOM errors.

### CPU Optimization Tips for v2.3.0

1. **Use Multi-Core CPUs**
   ```python
   import os
   # Reserve 2 cores for OS
   os.environ['XLA_FLAGS'] = f'--xla_force_host_platform_device_count={cpu_count - 2}'
   ```

2. **Optimize Thread Count**
   ```bash
   export OMP_NUM_THREADS=18  # For 20-core CPU
   export OPENBLAS_NUM_THREADS=18
   ```

3. **HPC Cluster Example (Slurm)**
   ```bash
   #!/bin/bash
   #SBATCH --nodes=1
   #SBATCH --ntasks-per-node=36
   #SBATCH --time=02:00:00

   export OMP_NUM_THREADS=34  # Reserve 2 for OS
   homodyne --config config.yaml
   ```

See `examples/cpu_optimization.py` for comprehensive CPU optimization guide.

---

## FAQ

### Q1: Why was GPU support removed?

**A:** Three main reasons:
1. **Maintenance burden** - GPU code added 40% complexity
2. **Reliability** - GPU OOM errors hard to debug, CPU more predictable
3. **Performance** - Multi-core CPU provides excellent performance for XPCS

### Q2: Can I still use v2.2.1 with GPU support?

**A:** Yes! v2.2.1 remains available on PyPI. Pin your version:
```bash
pip install homodyne==2.2.1
```

### Q3: Will v2.2.1 receive updates?

**A:** Critical bug fixes only (best effort). New features only in v2.3.0+.

### Q4: What if my CPU is too slow?

**A:** Options:
1. Use HPC cluster with 36-128 core nodes (highly recommended)
2. Stay on v2.2.1 with GPU support
3. Use data subsampling for exploratory analysis

### Q5: How do I optimize CPU performance?

**A:** See:
- `examples/cpu_optimization.py` - Comprehensive CPU guide
- `examples/multi_core_batch_processing.py` - Parallel workflows
- CPU optimization section in CLAUDE.md

### Q6: What about JAX GPU support in the future?

**A:** No plans to restore GPU support. Focus is on:
- HPC multi-core CPU optimization
- Distributed CPU computing (cluster parallelization)
- Memory-efficient CPU algorithms

### Q7: Can I use `CUDA_VISIBLE_DEVICES=""` workaround?

**A:** Not needed in v2.3.0 - all execution is CPU-only by design.

### Q8: Will this affect my existing results?

**A:** No. Results from v2.2.1 GPU and v2.3.0 CPU should be numerically identical (within floating-point precision).

### Q9: What if I encounter issues after upgrading?

**A:**
1. Check migration guide (this document)
2. Verify configuration files (remove GPU keys)
3. Report issues on GitHub with "v2.3.0 migration" label
4. If blocked: downgrade to v2.2.1 temporarily

### Q10: How long is v2.2.1 supported?

**A:**
- Available on PyPI: **Indefinitely**
- Critical bug fixes: **Best effort, 6-12 months**
- New features: **None (use v2.3.0)**

---

## Troubleshooting

### Issue 1: ImportError for GPU Functions

**Symptom:**
```python
ImportError: cannot import name 'configure_system_cuda' from 'homodyne.device'
```

**Solution:**
Remove GPU function imports:
```python
# ❌ REMOVE:
from homodyne.device import configure_system_cuda

# ✅ USE:
from homodyne.device import configure_optimal_device
```

### Issue 2: Unrecognized CLI Flags

**Symptom:**
```bash
error: unrecognized arguments: --force-cpu
```

**Solution:**
Remove GPU CLI flags:
```bash
# ❌ REMOVE:
homodyne --config config.yaml --force-cpu

# ✅ USE:
homodyne --config config.yaml
```

### Issue 3: Configuration Warnings

**Symptom:**
```
Warning: Unknown configuration key 'gpu_memory_fraction'
```

**Solution:**
Warnings are harmless (graceful degradation), but clean up config:
```bash
# Remove GPU keys from YAML
sed -i '/gpu_memory_fraction/d' config.yaml
sed -i '/force_cpu/d' config.yaml
```

### Issue 4: Performance Regression

**Symptom:**
Slower execution time compared to v2.2.1 GPU

**Solution:**
Optimize CPU configuration:
```python
# Use all available cores (minus 2 for OS)
import os
import psutil
cpu_count = psutil.cpu_count(logical=False)
os.environ['XLA_FLAGS'] = f'--xla_force_host_platform_device_count={cpu_count - 2}'
```

See `examples/cpu_optimization.py` for complete guide.

### Issue 5: Need GPU Performance

**Symptom:**
CPU-only performance insufficient for your use case

**Solution:**
Stay on v2.2.1:
```bash
pip install homodyne==2.2.1
```

Or use HPC cluster with 36+ CPU cores.

---

## Timeline

| Date | Event | Details |
|------|-------|---------|
| **November 6, 2025** | v2.2.1 released | Last GPU-supporting version |
| **November 7, 2025** | v2.3.0 released | GPU support removed |
| **November 7, 2025 - May 2026** | v2.2.1 critical bug fixes | Best effort maintenance |
| **May 2026+** | v2.2.1 maintenance mode | Available but unsupported |

---

## Feedback and Support

**Questions?**
- GitHub Issues: https://github.com/imewei/homodyne/issues
- Migration label: "v2.3.0 migration"

**Need GPU support?**
- Stay on v2.2.1 (recommended)
- File feature request (GPU re-add unlikely)

**Performance issues?**
- Review CPU optimization guides
- Share benchmarks for community help

---

## Summary

**Key Points:**
- ✅ v2.3.0 removes all GPU support
- ✅ v2.2.1 remains available for GPU users
- ✅ CPU-only provides excellent, reliable performance
- ✅ No migration path - choose v2.2.1 or v2.3.0
- ✅ Breaking change acknowledged and documented

**Recommendation:**
- **Most users:** Upgrade to v2.3.0 for simpler, reliable execution
- **GPU-dependent users:** Stay on v2.2.1 (maintenance mode)

---

*Last Updated: November 7, 2025 | Homodyne v2.3.0*
