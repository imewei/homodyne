# Homodyne Static Anisotropic Configuration Template
# ======================================================
# Optimized configuration for 3-parameter static anisotropic diffusion analysis.
# Model: Same physics as isotropic but analyzed across multiple phi angles
# Physics: D(t,φ) = D₀·t^α + D_offset with angle-dependent analysis
# Integration: Discrete numerical integration for stability with α ≤ -1
#
# Key features:
# - 3-parameter model with multi-angle data analysis
# - Advanced phi angle filtering for optimal scattering contrast
# - Target angle ranges optimized for anisotropic scattering detection
# - Enhanced data processing for multiple angles
# - Production-ready with intelligent fallback mechanisms
#
# This template differs from isotropic by:
# - Angle filtering to select optimal phi ranges
# - Multi-angle correlation analysis
# - Enhanced data validation for angle-dependent effects
#
# Usage:
#   1. Ensure your data contains multiple phi angles
#   2. Update experimental_data paths to point to your files
#   3. Adjust phi angle filtering ranges based on your scattering geometry
#   4. Run: homodyne --method vi --config this_file.yaml

# ==============================================================================
# TEMPLATE METADATA
# ==============================================================================
metadata:
  config_version: "2.0.0"
  description: "Static anisotropic diffusion analysis - 3 parameter multi-angle model with discrete integration"
  analysis_mode: "static_anisotropic"
  parameter_count: 3
  physics_model: "D(t,φ) = D₀·t^α + D_offset with angle filtering (discrete numerical integration)"
  integration_method: "discrete_numerical"
  diagonal_correction: "mandatory"
  recommended_use: "Multi-angle XPCS analysis for anisotropic systems with anomalous diffusion support"
  template_type: "production_ready"
  key_features:
    - "Multi-angle correlation analysis"
    - "Intelligent phi angle filtering"
    - "Discrete numerical integration for stability"
    - "Mandatory diagonal correction for consistency"
    - "Optimized for anisotropic scattering detection"

# ==============================================================================
# CORE ANALYSIS CONFIGURATION
# ==============================================================================

# Analysis mode: 3-parameter static anisotropic model
analysis_mode: "static_anisotropic"

# Core physics parameters
analyzer_parameters:
  # Time step between correlation measurements (seconds)
  dt: 0.1

  # Frame range for analysis (may need more frames for multi-angle statistics)
  start_frame: 1
  end_frame: 1000

  # Scattering parameters
  scattering:
    # Wave vector magnitude in Å⁻¹ (sample-dependent)
    wavevector_q: 0.0054

  # Geometry parameters (instrumental setup)
  geometry:
    # Stator-rotor gap in Angstroms (200 microns instrumental parameter)
    stator_rotor_gap: 2000000

# Analysis mode settings
analysis_settings:
  # Static mode enabled for anisotropic analysis
  static_mode: true
  static_submode: "anisotropic"

  model_description:
    type: "static_diffusion"
    parameters: 3
    physics: "Multi-angle anomalous diffusion with angle filtering"

# ==============================================================================
# DATA CONFIGURATION
# ==============================================================================

# Experimental data file paths (CUSTOMIZE THESE PATHS)
experimental_data:
  # Primary data location
  data_folder_path: "./data/sample/"
  data_file_name: "your_xpcs_data.hdf"

  # Phi angles (REQUIRED for anisotropic analysis)
  phi_angles_path: "./data/phi_angles/"
  phi_angles_file: "phi_list.txt"

  # Caching for performance (angle-specific caching)
  cache_file_path: "./data/sample/"
  cache_filename_template: "cached_c2_aniso_q{wavevector_q:.4f}_frames_{start_frame}_{end_frame}.npz"
  cache_compression: true

  # Data format
  data_type: "float64"
  file_format: "HDF5"
  exchange_key: "exchange"

# ==============================================================================
# PHI ANGLE FILTERING CONFIGURATION
# ==============================================================================

# Advanced phi angle filtering for anisotropic analysis
phi_filtering:
  enabled: true

  # Target angle ranges for optimal anisotropic scattering analysis
  # These ranges are optimized for detecting anisotropic diffusion patterns
  target_ranges:
    # Near 0° - parallel to potential anisotropy axis
    - min_angle: -10.0
      max_angle: 10.0
      description: "Parallel to primary axis"

    # Near 180° - antiparallel to anisotropy axis
    - min_angle: 170.0
      max_angle: 190.0
      description: "Antiparallel to primary axis"

    # Optional: perpendicular angles for comprehensive analysis
    # Uncomment if your system shows perpendicular anisotropy effects
    # - min_angle: 85.0
    #   max_angle: 95.0
    #   description: "Perpendicular axis 1"
    # - min_angle: 265.0
    #   max_angle: 275.0
    #   description: "Perpendicular axis 2"

  # Fallback behavior if no angles match target ranges
  fallback_to_all_angles: true

  # Filtering algorithm settings
  algorithm: "range_based"
  tolerance: 2.0 # Angular tolerance in degrees

  # Quality control for angle selection
  quality_control:
    min_angles_required: 2
    max_angle_spread: 20.0 # Maximum spread within a range
    validate_coverage: true

# ==============================================================================
# PARAMETER CONFIGURATION
# ==============================================================================

# Initial parameter values (CUSTOMIZE BASED ON YOUR SYSTEM)
initial_parameters:
  # 3-parameter model: D₀, α, D_offset (same as isotropic)
  parameter_names: ["D0", "alpha", "D_offset"]

  # Starting values for optimization
  # Note: Anisotropic systems may show different parameter values
  # compared to isotropic analysis of the same system
  values: [1000.0, -1.2, 0.0]

  # Parameter units for reference
  units: ["Å²/s", "dimensionless", "Å²/s"]

# Parameter bounds and constraints
parameter_space:
  bounds:
    # Diffusion coefficient D₀ (may have broader range for anisotropic systems)
    - name: D0
      min: 1.0
      max: 1000000.0
      type: TruncatedNormal
      prior_mu: 1000.0
      prior_sigma: 1000.0 # Broader prior for anisotropic uncertainty
      unit: "Å²/s"

    # Anomalous exponent α
    - name: alpha
      min: -10.0
      max: 10.0
      type: Normal
      prior_mu: -1.2
      prior_sigma: 0.3 # Slightly broader prior for anisotropic effects
      unit: "dimensionless"

    # Diffusion offset D_offset
    - name: D_offset
      min: -100000.0
      max: 100000.0
      type: Normal
      prior_mu: 0.0
      prior_sigma: 150.0 # Broader prior for potential anisotropic offsets
      unit: "Å²/s"

# ==============================================================================
# OPTIMIZATION CONFIGURATION
# ==============================================================================

# Optimization methods (enhanced for multi-angle analysis)
optimization:
  # Variational Inference (may need more iterations for multi-angle data)
  vi:
    enabled: true
    max_iterations: 1500 # Increased for multi-angle complexity
    learning_rate: 0.008 # Slightly reduced for stability
    convergence_tolerance: 1e-6
    batch_size: "auto"
    early_stopping: true
    patience: 75 # Increased patience for multi-angle convergence

  # MCMC for uncertainty quantification (important for anisotropic analysis)
  mcmc:
    enabled: true
    num_samples: 3000 # Increased for better posterior sampling
    num_warmup: 1500 # Increased warmup for multi-angle adaptation
    num_chains: 4
    target_accept_prob: 0.8

  # Hybrid pipeline (recommended for anisotropic analysis)
  hybrid:
    enabled: false # Enable for production-quality anisotropic analysis
    vi_initialization: true
    vi_samples_for_init: 750

# ==============================================================================
# NOISE ESTIMATION (OPTIONAL)
# ==============================================================================

# Optional hybrid NumPyro noise estimation for multi-angle analysis
noise_estimation:
  enabled: false # Set to true to enable automatic noise estimation
  model: "per_angle" # Use per-angle noise (optimal for anisotropic data)

  # Adam optimization settings for multi-angle noise estimation
  adam_config:
    learning_rate: 0.01
    max_epochs: 500 # More steps needed for per-angle estimation
    convergence_threshold: 1e-6
    early_stopping: true # Enable early stopping for efficiency

  # Posterior sampling for uncertainty quantification
  posterior_samples: 1200 # Higher count for per-angle uncertainty estimates

  # Quality control for multi-angle noise estimation
  validation:
    check_convergence: true # Verify optimization convergence
    reasonable_range: [1e-4, 1.0] # Expected noise range for each angle
    warn_outliers: true # Warn about unusual per-angle estimates

  # Per-angle model settings
  per_angle:
    min_angles_required: 2 # Minimum angles needed for analysis
    validate_coverage: true # Ensure proper angle coverage

  # Usage Examples:
  # homodyne --method vi --estimate-noise config.yaml data.h5
  # homodyne --method vi --estimate-noise --noise-model per_angle config.yaml data.h5
  # homodyne --method mcmc --estimate-noise --noise-model per_angle config.yaml data.h5

# ==============================================================================
# PERFORMANCE AND LOGGING
# ==============================================================================

# Enhanced performance optimization for multi-angle data
performance:
  memory_optimization:
    enabled: true
    max_memory_usage_gb: 6.0 # Increased for multi-angle processing
    chunk_size: 8000 # Smaller chunks for angle-dependent processing
    enable_caching: true
    cache_strategy: "adaptive"

  computation:
    enable_jit: true
    gpu_acceleration: "auto"
    cpu_threads: "auto"
    vectorization_level: "high" # Important for multi-angle processing

# Enhanced logging for anisotropic analysis
logging:
  enabled: true
  level: "INFO"

  console:
    enabled: true
    level: "INFO"
    format: "detailed" # More detailed for multi-angle debugging
    colors: true
    show_progress: true

  file:
    enabled: false # Enable for detailed anisotropic analysis logging
    level: "DEBUG"
    path: "./logs/"
    filename: "homodyne_anisotropic.log"

  # Module-specific logging for angle processing
  modules:
    "homodyne.data.phi_filtering": "INFO"
    "homodyne.data.xpcs_loader": "INFO"
    "jax._src": "WARNING"

# ==============================================================================
# QUALITY CONTROL FOR MULTI-ANGLE ANALYSIS
# ==============================================================================

# Quality control specific to anisotropic analysis
quality_control:
  enabled: false # Enable for production anisotropic analysis

  # Angle-specific quality checks
  angle_quality:
    validate_angle_coverage: true
    min_angles_per_range: 1
    check_angle_distribution: true

  # Multi-angle data validation
  multi_angle_validation:
    check_correlation_consistency: true
    validate_angle_dependencies: true
    detect_anomalous_angles: true

# ==============================================================================
# OUTPUT CONFIGURATION
# ==============================================================================

# Enhanced output for multi-angle analysis
output:
  base_directory: "./homodyne_results/"

  formats:
    hdf5: true
    json: true
    csv: true

  plots:
    enabled: true
    formats: ["png"]
    dpi: 300
    style: "publication"

    # Rendering mode selection (hybrid plotting system)
    # IMPORTANT: Controls speed vs quality tradeoff for C2 heatmap plots
    preview_mode:
      false # false = publication quality (matplotlib, slower)
      # true = fast preview (Datashader, 5-10x faster)

    # Datashader configuration (used when preview_mode: true)
    datashader:
      canvas_width: 1200 # Rendering resolution in pixels (increased from 800)
      canvas_height: 1200 # Higher values = more detail, larger files
      gpu_acceleration: true # Use GPU if CuPy available

    # Matplotlib configuration (used when preview_mode: false)
    matplotlib:
      interpolation: "bilinear" # none | bilinear | bicubic
      use_tight_layout: true
      savefig_kwargs:
        bbox_inches: "tight"
        pad_inches: 0.1

    # Essential plots for anisotropic analysis
    correlation_function: true
    fit_quality: true
    parameter_distributions: true
    residual_analysis: true

    # Anisotropic-specific plots
    angle_coverage: true # Show which angles were used
    angle_correlation: true # Correlation quality vs angle

# ==============================================================================
# VALIDATION
# ==============================================================================

# Enhanced validation for multi-angle analysis
validation:
  strict_mode: false
  check_file_existence: true
  validate_parameter_ranges: true
  check_mode_compatibility: true

  # Anisotropic-specific validation
  angle_validation:
    require_multiple_angles: true
    min_angle_count: 2
    validate_angle_ranges: true
# ==============================================================================
# USAGE NOTES
# ==============================================================================
#
# ANISOTROPIC ANALYSIS QUICK START:
# 1. Ensure your data contains multiple phi angles (check phi_angles_file)
# 2. Update paths in experimental_data section
# 3. Review phi_filtering target_ranges based on your scattering geometry
# 4. Adjust initial_parameters.values for your system
# 5. Run: homodyne --method vi --config this_file.yaml
#
# PHI ANGLE FILTERING GUIDANCE:
# - Default ranges [-10°,10°] and [170°,190°] work for most anisotropic systems
# - Add perpendicular ranges (85°-95°, 265°-275°) for comprehensive analysis
# - Increase tolerance to 5.0° if you have sparse angle coverage
# - Enable fallback_to_all_angles for systems with unknown anisotropy direction
#
# PARAMETER INTERPRETATION:
# - D₀: May differ from isotropic analysis due to angle-averaged effects
# - α: Anisotropic systems may show angle-dependent anomalous behavior
# - D_offset: May capture baseline anisotropic contributions
#
# OPTIMIZATION TIPS:
# - Use more iterations (1500) due to multi-angle complexity
# - Enable MCMC for uncertainty quantification in anisotropic parameters
# - Consider hybrid pipeline for production-quality results
# - Monitor convergence across all angle ranges
#
# TROUBLESHOOTING:
# - If no angles found: check phi_angles_file and target_ranges compatibility
# - If convergence issues: reduce learning_rate to 0.005 and increase iterations
# - If memory issues: reduce chunk_size to 5000
# - If inconsistent results: enable quality_control for angle validation
#
# ANISOTROPIC vs ISOTROPIC:
# - Anisotropic analysis provides angle-resolved information
# - Results may differ from isotropic analysis of the same data
# - Use isotropic analysis first to establish baseline parameters
# - Anisotropic analysis can reveal directional diffusion effects
