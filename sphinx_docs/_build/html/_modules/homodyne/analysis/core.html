

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>homodyne.analysis.core &mdash; Homodyne Analysis 6.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=66ead900" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=54d05895"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980b9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Homodyne Analysis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analysis_modes.html">Analysis Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Configuration System</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../optimization_methods.html">Optimization Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scaling_optimization.html">Scaling Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance.html">Performance Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_validation.html">Data Validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">homodyne</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">Testing and Quality Assurance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980b9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Homodyne Analysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">homodyne.analysis.core</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for homodyne.analysis.core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core Analysis Engine for Homodyne Scattering Analysis</span>
<span class="sd">=====================================================</span>

<span class="sd">High-performance homodyne scattering analysis with configuration management.</span>

<span class="sd">This module implements the complete analysis pipeline for XPCS data in</span>
<span class="sd">nonequilibrium laminar flow systems, based on He et al. (2024).</span>

<span class="sd">Physical Theory</span>
<span class="sd">---------------</span>
<span class="sd">The theoretical framework describes the time-dependent intensity correlation function</span>
<span class="sd">g2(φ,t₁,t₂) for X-ray photon correlation spectroscopy (XPCS) measurements of fluids</span>
<span class="sd">under nonequilibrium laminar flow conditions. The model captures the interplay between</span>
<span class="sd">Brownian diffusion and advective shear flow in the two-time correlation dynamics.</span>

<span class="sd">The correlation function has the form:</span>
<span class="sd">    g2(φ,t₁,t₂) = 1 + contrast × [g1(φ,t₁,t₂)]²</span>

<span class="sd">where g1 is the field correlation function with separable contributions:</span>
<span class="sd">    g1(φ,t₁,t₂) = g1_diff(t₁,t₂) × g1_shear(φ,t₁,t₂)</span>

<span class="sd">Diffusion Contribution:</span>
<span class="sd">    g1_diff(t₁,t₂) = exp[-q²/2 ∫|t₂-t₁| D(t&#39;)dt&#39;]</span>

<span class="sd">Shear Contribution:</span>
<span class="sd">    g1_shear(φ,t₁,t₂) = [sinc(Φ(φ,t₁,t₂))]²</span>
<span class="sd">    Φ(φ,t₁,t₂) = (1/2π) q L cos(φ₀-φ) ∫|t₂-t₁| γ̇(t&#39;)dt&#39;</span>

<span class="sd">Time-Dependent Transport Coefficients:</span>
<span class="sd">    D(t) = D₀ t^α + D_offset    (anomalous diffusion)</span>
<span class="sd">    γ̇(t) = γ̇₀ t^β + γ̇_offset   (time-dependent shear rate)</span>

<span class="sd">Parameter Models:</span>
<span class="sd">Static Mode (3 parameters):</span>
<span class="sd">- D₀: Reference diffusion coefficient [Å²/s]</span>
<span class="sd">- α: Diffusion time-dependence exponent [-]</span>
<span class="sd">- D_offset: Baseline diffusion [Å²/s]</span>
<span class="sd">(γ̇₀, β, γ̇_offset, φ₀ = 0 - automatically set and irrelevant)</span>

<span class="sd">Laminar Flow Mode (7 parameters):</span>
<span class="sd">- D₀: Reference diffusion coefficient [Å²/s]</span>
<span class="sd">- α: Diffusion time-dependence exponent [-]</span>
<span class="sd">- D_offset: Baseline diffusion [Å²/s]</span>
<span class="sd">- γ̇₀: Reference shear rate [s⁻¹]</span>
<span class="sd">- β: Shear rate time-dependence exponent [-]</span>
<span class="sd">- γ̇_offset: Baseline shear rate [s⁻¹]</span>
<span class="sd">- φ₀: Angular offset parameter [degrees]</span>

<span class="sd">Experimental Parameters:</span>
<span class="sd">- q: Scattering wavevector magnitude [Å⁻¹]</span>
<span class="sd">- L: Characteristic length scale (gap size) [Å]</span>
<span class="sd">- φ: Scattering angle [degrees]</span>
<span class="sd">- dt: Time step between frames [s/frame]</span>

<span class="sd">Features</span>
<span class="sd">--------</span>
<span class="sd">- JSON-based configuration management</span>
<span class="sd">- Experimental data loading with intelligent caching</span>
<span class="sd">- Parallel processing for multi-angle calculations</span>
<span class="sd">- Performance optimization with Numba JIT compilation</span>
<span class="sd">- Comprehensive parameter validation and bounds checking</span>
<span class="sd">- Memory-efficient matrix operations and caching</span>

<span class="sd">Usage</span>
<span class="sd">-----</span>
<span class="sd">&gt;&gt;&gt; from homodyne.analysis.core import HomodyneAnalysisCore</span>
<span class="sd">&gt;&gt;&gt; analyzer = HomodyneAnalysisCore(&#39;config.json&#39;)</span>
<span class="sd">&gt;&gt;&gt; data = analyzer.load_experimental_data()</span>
<span class="sd">&gt;&gt;&gt; chi2 = analyzer.calculate_chi_squared_optimized(parameters, phi_angles, data[0])</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">He, H., Chen, W., et al. (2024). &quot;Time-dependent dynamics in nonequilibrium</span>
<span class="sd">laminar flow systems via X-ray photon correlation spectroscopy.&quot;</span>

<span class="sd">Authors: Wei Chen, Hongrui He</span>
<span class="sd">Institution: Argonne National Laboratory &amp; University of Chicago</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Import optional dependencies</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyxpcsviewer</span><span class="w"> </span><span class="kn">import</span> <span class="n">XpcsFile</span> <span class="k">as</span> <span class="n">xf</span>

    <span class="n">PYXPCSVIEWER_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PYXPCSVIEWER_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">xf</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Import performance optimization dependencies</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span>

    <span class="n">NUMBA_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">NUMBA_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">jit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">njit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span>

    <span class="n">prange</span> <span class="o">=</span> <span class="nb">range</span>

<span class="c1"># Import core dependencies from the main module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..core.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_time_integral_matrix_numba</span><span class="p">,</span>
    <span class="n">calculate_diffusion_coefficient_numba</span><span class="p">,</span>
    <span class="n">calculate_shear_rate_numba</span><span class="p">,</span>
    <span class="n">compute_g1_correlation_numba</span><span class="p">,</span>
    <span class="n">compute_sinc_squared_numba</span><span class="p">,</span>
    <span class="n">memory_efficient_cache</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Global optimization counter for performance tracking</span>
<span class="n">OPTIMIZATION_COUNTER</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Default thread count for parallelization</span>
<span class="n">DEFAULT_NUM_THREADS</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>

<span class="c1"># Check for optional dependencies</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pymc</span>  <span class="c1"># noqa: F401</span>

    <span class="n">PYMC_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PYMC_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>



<div class="viewcode-block" id="HomodyneAnalysisCore">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HomodyneAnalysisCore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Core analysis engine for homodyne scattering data.</span>

<span class="sd">    This class provides the fundamental analysis capabilities including:</span>
<span class="sd">    - Configuration-driven parameter management</span>
<span class="sd">    - Experimental data loading with intelligent caching</span>
<span class="sd">    - Correlation function calculations with performance optimizations</span>
<span class="sd">    - Time-dependent diffusion and shear rate modeling</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HomodyneAnalysisCore.__init__">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;homodyne_config.json&quot;</span><span class="p">,</span>
        <span class="n">config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the core analysis system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config_file : str</span>
<span class="sd">            Path to JSON configuration file</span>
<span class="sd">        config_override : dict, optional</span>
<span class="sd">            Runtime configuration overrides</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load and validate configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span><span class="o">.</span><span class="n">config</span>

        <span class="c1"># Apply overrides if provided</span>
        <span class="k">if</span> <span class="n">config_override</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_config_overrides</span><span class="p">(</span><span class="n">config_override</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

        <span class="c1"># Extract core parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_parameters</span><span class="p">()</span>

        <span class="c1"># Setup performance optimizations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_performance</span><span class="p">()</span>

        <span class="c1"># Initialize caching systems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_caching</span><span class="p">()</span>

        <span class="c1"># Warm up JIT functions</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">NUMBA_AVAILABLE</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;performance_settings&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warmup_numba&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_numba_functions</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_initialization_summary</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize core analysis parameters from configuration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Configuration not loaded: self.config is None.&quot;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;analyzer_parameters&quot;</span><span class="p">]</span>

        <span class="c1"># Time and frame parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;temporal&quot;</span><span class="p">][</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;temporal&quot;</span><span class="p">][</span><span class="s2">&quot;start_frame&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;temporal&quot;</span><span class="p">][</span><span class="s2">&quot;end_frame&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span>

        <span class="c1"># Physical parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavevector_q</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;scattering&quot;</span><span class="p">][</span><span class="s2">&quot;wavevector_q&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stator_rotor_gap</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;stator_rotor_gap&quot;</span><span class="p">]</span>

        <span class="c1"># Parameter counts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_shear_rate_params</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># Pre-compute constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavevector_q_squared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavevector_q</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavevector_q_squared_half_dt</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavevector_q_squared</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinc_prefactor</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">0.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavevector_q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stator_rotor_gap</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="p">)</span>

        <span class="c1"># Time array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure performance settings.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Configuration not loaded: self.config is None.&quot;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;analyzer_parameters&quot;</span><span class="p">]</span>
        <span class="n">comp_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;computational&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Thread configuration</span>
        <span class="k">if</span> <span class="n">comp_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auto_detect_cores&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">detected</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
            <span class="n">max_threads</span> <span class="o">=</span> <span class="n">comp_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_threads_limit&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">detected</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span> <span class="o">=</span> <span class="n">comp_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_threads&quot;</span><span class="p">,</span> <span class="n">DEFAULT_NUM_THREADS</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_caching</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize caching systems.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_experimental_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_phi_angles</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Initialize plotting cache variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_experimental_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_phi_angles</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_warmup_numba_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pre-compile Numba functions to eliminate first-call overhead.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NUMBA_AVAILABLE</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Warming up Numba JIT functions...&quot;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Create small test arrays</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">test_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">test_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">test_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Warm up each function</span>
            <span class="n">create_time_integral_matrix_numba</span><span class="p">(</span><span class="n">test_array</span><span class="p">)</span>
            <span class="n">calculate_diffusion_coefficient_numba</span><span class="p">(</span><span class="n">test_time</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">calculate_shear_rate_numba</span><span class="p">(</span><span class="n">test_time</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">compute_g1_correlation_numba</span><span class="p">(</span><span class="n">test_matrix</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">compute_sinc_squared_numba</span><span class="p">(</span><span class="n">test_matrix</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numba warmup completed in </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numba warmup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Full traceback for Numba warmup failure:&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_print_initialization_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print initialization summary.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HomodyneAnalysis Core initialized:&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  • Frames: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="si">}</span><span class="s2"> frames)&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  • Time step: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="si">}</span><span class="s2"> s/frame&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  • Wavevector: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wavevector_q</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> Å⁻¹&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  • Gap size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stator_rotor_gap</span><span class="o">/</span><span class="mf">1e4</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> μm&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  • Threads: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  • Optimizations: </span><span class="si">{</span><span class="s1">&#39;Numba JIT&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">NUMBA_AVAILABLE</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Pure Python&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="HomodyneAnalysisCore.is_static_mode">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.is_static_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_static_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the analysis is configured for static (no-flow) mode.</span>

<span class="sd">        In static mode:</span>
<span class="sd">        - Shear rate γ̇ = 0</span>
<span class="sd">        - Shear exponent β = 0</span>
<span class="sd">        - Shear offset γ̇_offset = 0</span>
<span class="sd">        - sinc² function = 1 (no shear decorrelation)</span>
<span class="sd">        - Only diffusion contribution g₁_diff remains</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if static mode is enabled in configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for static mode flag in configuration</span>
        <span class="n">analysis_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_settings&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">analysis_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.is_static_parameters">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.is_static_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_static_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shear_params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if shear parameters correspond to static conditions.</span>

<span class="sd">        In static conditions:</span>
<span class="sd">        - gamma_dot_t0 (shear_params[0]) ≈ 0</span>
<span class="sd">        - beta (shear_params[1]) = 0 (no time dependence)</span>
<span class="sd">        - gamma_dot_offset (shear_params[2]) ≈ 0</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shear_params : np.ndarray</span>
<span class="sd">            Shear rate parameters [gamma_dot_t0, beta, gamma_dot_offset]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if parameters indicate static conditions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shear_params</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">gamma_dot_t0</span> <span class="o">=</span> <span class="n">shear_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">shear_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">gamma_dot_offset</span> <span class="o">=</span> <span class="n">shear_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Define small threshold for &quot;effectively zero&quot;</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1e-10</span>

        <span class="c1"># Check if all shear parameters are effectively zero</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">gamma_dot_t0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">gamma_dot_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.get_effective_parameter_count">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.get_effective_parameter_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_effective_parameter_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the effective number of parameters based on analysis mode.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Number of parameters actually used in the analysis:</span>
<span class="sd">            - Static mode: 3 (only diffusion parameters: D₀, α, D_offset)</span>
<span class="sd">            - Laminar flow mode: 7 (all parameters including shear and φ₀)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_static_mode</span><span class="p">():</span>
            <span class="c1"># Static mode: only diffusion parameters are meaningful</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span>  <span class="c1"># 3 parameters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Laminar flow mode: all parameters are used</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shear_rate_params</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>  <span class="c1"># 7 parameters</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.get_effective_parameters">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.get_effective_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_effective_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract only the effective parameters based on analysis mode.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters : np.ndarray</span>
<span class="sd">            Full parameter array [D0, alpha, D_offset, gamma_dot_t0, beta, gamma_dot_t_offset, phi0]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Effective parameters based on mode:</span>
<span class="sd">            - Static mode: [D0, alpha, D_offset] (shear params set to 0, phi0 ignored)</span>
<span class="sd">            - Laminar flow mode: all parameters as provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_static_mode</span><span class="p">():</span>
            <span class="c1"># Return only diffusion parameters, set others to zero</span>
            <span class="n">effective_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># Standard 7-parameter array</span>
            <span class="n">effective_params</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span>
                <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span>
            <span class="p">]</span>
            <span class="c1"># Shear parameters (indices 3,4,5) remain zero</span>
            <span class="c1"># phi0 (index 6) remains zero - irrelevant in static mode</span>
            <span class="k">return</span> <span class="n">effective_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return all parameters as provided</span>
            <span class="k">return</span> <span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_config_overrides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overrides</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply configuration overrides with deep merging.&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">deep_update</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">key</span> <span class="ow">in</span> <span class="n">base</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">deep_update</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">base</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">deep_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">overrides</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">overrides</span><span class="p">)</span><span class="si">}</span><span class="s2"> configuration overrides&quot;</span><span class="p">)</span>

    <span class="c1"># ============================================================================</span>
    <span class="c1"># DATA LOADING AND PREPROCESSING</span>
    <span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="HomodyneAnalysisCore.load_experimental_data">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.load_experimental_data">[docs]</a>
    <span class="nd">@memory_efficient_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_experimental_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load experimental correlation data with caching.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (c2_experimental, time_length, phi_angles, num_angles)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting load_experimental_data method&quot;</span><span class="p">)</span>

        <span class="c1"># Return cached data if available</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cached_experimental_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_phi_angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cache hit: returning cached experimental data&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cached_experimental_data</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cached_phi_angles</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cached_phi_angles</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Ensure configuration is loaded</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Configuration not loaded: self.config is None.&quot;</span><span class="p">)</span>

        <span class="c1"># Load angle configuration - skip for isotropic static mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span><span class="o">.</span><span class="n">is_static_isotropic_enabled</span><span class="p">():</span>
            <span class="c1"># In isotropic static mode, create a single dummy angle</span>
            <span class="n">phi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">num_angles</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Isotropic static mode: Using single dummy angle (0.0°) instead of loading phi_angles_file&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Normal mode: load phi angles from file</span>
            <span class="n">phi_angles_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phi_angles_path&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">phi_angles_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">][</span><span class="s2">&quot;phi_angles_file&quot;</span><span class="p">]</span>
            <span class="n">phi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">phi_angles_path</span><span class="p">,</span> <span class="n">phi_angles_file</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading phi angles from: </span><span class="si">{</span><span class="n">phi_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">phi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">phi_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="c1"># Ensure phi_angles is always an array, even for single values</span>
            <span class="n">phi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">)</span>
            <span class="n">num_angles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">num_angles</span><span class="si">}</span><span class="s2"> phi angles: </span><span class="si">{</span><span class="n">phi_angles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check for cached processed data</span>
        <span class="n">cache_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">][</span><span class="s2">&quot;cache_filename_template&quot;</span><span class="p">]</span>
        <span class="n">cache_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_file_path&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">cache_filename</span> <span class="o">=</span> <span class="n">cache_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">start_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span>
        <span class="p">)</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_file_path</span><span class="p">,</span> <span class="n">cache_filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking for cached data at: </span><span class="si">{</span><span class="n">cache_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache hit: Loading cached data from </span><span class="si">{</span><span class="n">cache_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cache_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">c2_experimental</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;c2_exp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cached data shape: </span><span class="si">{</span><span class="n">c2_experimental</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cache miss: Loading raw data (cache file </span><span class="si">{</span><span class="n">cache_file</span><span class="si">}</span><span class="s2"> not found)&quot;</span>
            <span class="p">)</span>
            <span class="n">c2_experimental</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_raw_data</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">,</span> <span class="n">num_angles</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw data loaded with shape: </span><span class="si">{</span><span class="n">c2_experimental</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Save to cache</span>
            <span class="n">compression_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;cache_compression&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Saving data to cache with compression=&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;enabled&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">compression_enabled</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;disabled&#39;</span><span class="si">}</span><span class="s2">: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">compression_enabled</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="n">c2_exp</span><span class="o">=</span><span class="n">c2_experimental</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="n">c2_exp</span><span class="o">=</span><span class="n">c2_experimental</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data cached successfully to: </span><span class="si">{</span><span class="n">cache_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Apply diagonal correction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;advanced_settings&quot;</span><span class="p">][</span><span class="s2">&quot;data_loading&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;use_diagonal_correction&quot;</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Applying diagonal correction to correlation matrices&quot;</span><span class="p">)</span>
            <span class="n">c2_experimental</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_diagonal_correction_vectorized</span><span class="p">(</span><span class="n">c2_experimental</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Diagonal correction completed&quot;</span><span class="p">)</span>

        <span class="c1"># Cache in memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_experimental_data</span> <span class="o">=</span> <span class="n">c2_experimental</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_phi_angles</span> <span class="o">=</span> <span class="n">phi_angles</span>
        
        <span class="c1"># Cache for plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_experimental_data</span> <span class="o">=</span> <span class="n">c2_experimental</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_phi_angles</span> <span class="o">=</span> <span class="n">phi_angles</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data cached in memory - final shape: </span><span class="si">{</span><span class="n">c2_experimental</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Plot experimental data for validation if enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_integration&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_workflow&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plot_experimental_data_on_load&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting experimental data for validation...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_experimental_data_validation</span><span class="p">(</span><span class="n">c2_experimental</span><span class="p">,</span> <span class="n">phi_angles</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Experimental data validation plot created successfully&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create experimental data validation plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load_experimental_data method completed successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c2_experimental</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">,</span> <span class="n">phi_angles</span><span class="p">,</span> <span class="n">num_angles</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_load_raw_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">num_angles</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load raw data from HDF5 files.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting _load_raw_data method&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Configuration not loaded: self.config is None.&quot;</span><span class="p">)</span>

        <span class="n">data_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">]</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">data_config</span><span class="p">[</span><span class="s2">&quot;data_folder_path&quot;</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">data_config</span><span class="p">[</span><span class="s2">&quot;data_file_name&quot;</span><span class="p">]</span>
        <span class="n">exchange_key</span> <span class="o">=</span> <span class="n">data_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exchange_key&quot;</span><span class="p">,</span> <span class="s2">&quot;exchange&quot;</span><span class="p">)</span>

        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opening HDF5 data file: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exchange key: </span><span class="si">{</span><span class="n">exchange_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Frame range: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="si">}</span><span class="s2"> (length: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Open data file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PYXPCSVIEWER_AVAILABLE</span> <span class="ow">or</span> <span class="n">xf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;pyxpcsviewer is required for loading raw experimental data. &quot;</span>
                <span class="s2">&quot;Install it with: pip install pyxpcsviewer&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_file</span> <span class="o">=</span> <span class="n">xf</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully opened HDF5 file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open HDF5 file </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Pre-allocate output</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_angles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">)</span>
        <span class="n">c2_experimental</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-allocated output array with shape: </span><span class="si">{</span><span class="n">expected_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Handle data loading for isotropic static mode vs normal mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span><span class="o">.</span><span class="n">is_static_isotropic_enabled</span><span class="p">():</span>
            <span class="c1"># In isotropic static mode, load data only once and use for the single dummy angle</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Isotropic static mode: Loading single correlation matrix for dummy angle&quot;</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load data once for isotropic case</span>
                <span class="n">raw_data</span> <span class="o">=</span> <span class="n">data_file</span><span class="o">.</span><span class="n">get_twotime_c2</span><span class="p">(</span><span class="n">exchange_key</span><span class="p">,</span> <span class="n">correct_diag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raw_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;get_twotime_c2 returned None in isotropic static mode&quot;</span><span class="p">)</span>
                
                <span class="c1"># Ensure raw_data is a NumPy array</span>
                <span class="n">raw_data_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
                <span class="n">sliced_data</span> <span class="o">=</span> <span class="n">raw_data_np</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="c1"># Use the same data for the single dummy angle</span>
                <span class="n">c2_experimental</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sliced_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Isotropic mode - Raw data shape: </span><span class="si">{</span><span class="n">raw_data_np</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> -&gt; sliced: </span><span class="si">{</span><span class="n">sliced_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load data in isotropic static mode: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Normal mode: load data for each angle</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data for </span><span class="si">{</span><span class="n">num_angles</span><span class="si">}</span><span class="s2"> angles...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_angles</span><span class="p">):</span>
                <span class="n">angle_deg</span> <span class="o">=</span> <span class="n">phi_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading angle </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_angles</span><span class="si">}</span><span class="s2"> (φ=</span><span class="si">{</span><span class="n">angle_deg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°)&quot;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Fix: Pass correct_diag as bool, not int. If you want diagonal correction, set to True, else False.</span>
                    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">data_file</span><span class="o">.</span><span class="n">get_twotime_c2</span><span class="p">(</span><span class="n">exchange_key</span><span class="p">,</span> <span class="n">correct_diag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">raw_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;get_twotime_c2 returned None for angle </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (φ=</span><span class="si">{</span><span class="n">angle_deg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°)&quot;</span>
                        <span class="p">)</span>
                    <span class="c1"># Ensure raw_data is a NumPy array</span>
                    <span class="n">raw_data_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
                    <span class="n">sliced_data</span> <span class="o">=</span> <span class="n">raw_data_np</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="n">c2_experimental</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sliced_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  Raw data shape: </span><span class="si">{</span><span class="n">raw_data_np</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> -&gt; sliced: </span><span class="si">{</span><span class="n">sliced_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to load data for angle </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (φ=</span><span class="si">{</span><span class="n">angle_deg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Successfully loaded raw data with final shape: </span><span class="si">{</span><span class="n">c2_experimental</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">c2_experimental</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fix_diagonal_correction_vectorized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c2_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply diagonal correction to correlation matrices.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;advanced_settings&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data_loading&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vectorized_diagonal_fix&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">c2_data</span>

        <span class="n">num_angles</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c2_data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">indices_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">indices_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">angle_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_angles</span><span class="p">):</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">c2_data</span><span class="p">[</span><span class="n">angle_idx</span><span class="p">]</span>

            <span class="c1"># Extract side-band values</span>
            <span class="n">side_band</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">indices_i</span><span class="p">,</span> <span class="n">indices_j</span><span class="p">]</span>

            <span class="c1"># Compute corrected diagonal</span>
            <span class="n">diagonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">diagonal</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">side_band</span>
            <span class="n">diagonal</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">side_band</span>

            <span class="c1"># Normalization</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">norm</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>

            <span class="c1"># Apply correction</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">diagonal</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c2_data</span>

    <span class="c1"># ============================================================================</span>
    <span class="c1"># CORRELATION FUNCTION CALCULATIONS</span>
    <span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="HomodyneAnalysisCore.calculate_diffusion_coefficient_optimized">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.calculate_diffusion_coefficient_optimized">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_diffusion_coefficient_optimized</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate time-dependent diffusion coefficient.&quot;&quot;&quot;</span>
        <span class="n">D0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">D_offset</span> <span class="o">=</span> <span class="n">params</span>

        <span class="k">if</span> <span class="n">NUMBA_AVAILABLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calculate_diffusion_coefficient_numba</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_array</span><span class="p">,</span> <span class="n">D0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">D_offset</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">D0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_array</span><span class="o">**</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">D_offset</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.calculate_shear_rate_optimized">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.calculate_shear_rate_optimized">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_shear_rate_optimized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate time-dependent shear rate.&quot;&quot;&quot;</span>
        <span class="n">gamma_dot_t0</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma_dot_t_offset</span> <span class="o">=</span> <span class="n">params</span>

        <span class="k">if</span> <span class="n">NUMBA_AVAILABLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calculate_shear_rate_numba</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_array</span><span class="p">,</span> <span class="n">gamma_dot_t0</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma_dot_t_offset</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gamma_dot_t0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_array</span><span class="o">**</span><span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="n">gamma_dot_t_offset</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.update_frame_range">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.update_frame_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_frame_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update frame range with validation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_frame : int</span>
<span class="sd">            New start frame</span>
<span class="sd">        end_frame : int</span>
<span class="sd">            New end frame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start_frame</span> <span class="o">&gt;=</span> <span class="n">end_frame</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid frame range: start_frame (</span><span class="si">{</span><span class="n">start_frame</span><span class="si">}</span><span class="s2">) must be &lt; end_frame (</span><span class="si">{</span><span class="n">end_frame</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">start_frame</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;start_frame must be &gt;= 0, got </span><span class="si">{</span><span class="n">start_frame</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Configuration not loaded: self.config is None.&quot;</span><span class="p">)</span>
        <span class="n">min_frames</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation_rules&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;frame_range&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minimum_frames&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">frame_count</span> <span class="o">=</span> <span class="n">end_frame</span> <span class="o">-</span> <span class="n">start_frame</span>
        <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&lt;</span> <span class="n">min_frames</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame count (</span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s2">) must be &gt;= </span><span class="si">{</span><span class="n">min_frames</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update configuration and recalculate derived parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Configuration not loaded: self.config is None.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;analyzer_parameters&quot;</span><span class="p">][</span><span class="s2">&quot;temporal&quot;</span><span class="p">][</span><span class="s2">&quot;start_frame&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;analyzer_parameters&quot;</span><span class="p">][</span><span class="s2">&quot;temporal&quot;</span><span class="p">][</span><span class="s2">&quot;end_frame&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_frame</span>

        <span class="c1"># Re-initialize parameters with new frame range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_parameters</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Frame range updated to </span><span class="si">{</span><span class="n">start_frame</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">end_frame</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s2"> frames)&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.create_time_integral_matrix_cached">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.create_time_integral_matrix_cached">[docs]</a>
    <span class="nd">@memory_efficient_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_time_integral_matrix_cached</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">param_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">time_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create cached time integral matrix.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;advanced_settings&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;integral_matrix&quot;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_matrices&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># Direct computation when caching is disabled or config is None</span>
            <span class="k">if</span> <span class="n">NUMBA_AVAILABLE</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">create_time_integral_matrix_numba</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">array_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>
                <span class="n">cumulative_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>
                <span class="n">cumsum_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">cumulative_sum</span><span class="p">,</span> <span class="p">(</span><span class="n">array_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cumsum_matrix</span> <span class="o">-</span> <span class="n">cumsum_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">NUMBA_AVAILABLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">create_time_integral_matrix_numba</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>
            <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>
            <span class="n">cumsum_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">cumsum</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cumsum_matrix</span> <span class="o">-</span> <span class="n">cumsum_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.calculate_c2_single_angle_optimized">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.calculate_c2_single_angle_optimized">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_c2_single_angle_optimized</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">phi_angle</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate correlation function for a single angle.</span>

<span class="sd">        Supports both laminar flow and static (no-flow) cases:</span>
<span class="sd">        - Laminar flow: Full 7-parameter model with diffusion and shear contributions</span>
<span class="sd">        - Static case: Only diffusion contribution (sinc² = 1), φ₀ irrelevant and set to 0</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters : np.ndarray</span>
<span class="sd">            Model parameters [D0, alpha, D_offset, gamma_dot_t0, beta, gamma_dot_t_offset, phi0]</span>
<span class="sd">            In static mode: only first 3 diffusion parameters are used, others ignored/set to 0</span>
<span class="sd">        phi_angle : float</span>
<span class="sd">            Scattering angle in degrees</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Correlation matrix c2(t1, t2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if we&#39;re in static mode</span>
        <span class="n">static_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_static_mode</span><span class="p">()</span>

        <span class="c1"># Extract parameters</span>
        <span class="n">diffusion_params</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span><span class="p">]</span>
        <span class="n">shear_params</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shear_rate_params</span>
        <span class="p">]</span>
        <span class="n">phi_offset</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Calculate time-dependent quantities</span>
        <span class="n">param_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">parameters</span><span class="p">))</span>
        <span class="n">D_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_diffusion_coefficient_optimized</span><span class="p">(</span><span class="n">diffusion_params</span><span class="p">)</span>

        <span class="c1"># Create diffusion integral matrix</span>
        <span class="n">D_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_time_integral_matrix_cached</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;D_</span><span class="si">{</span><span class="n">param_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">D_t</span><span class="p">)</span>

        <span class="c1"># Compute g1 correlation (diffusion contribution)</span>
        <span class="k">if</span> <span class="n">NUMBA_AVAILABLE</span><span class="p">:</span>
            <span class="n">g1</span> <span class="o">=</span> <span class="n">compute_g1_correlation_numba</span><span class="p">(</span>
                <span class="n">D_integral</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavevector_q_squared_half_dt</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">wavevector_q_squared_half_dt</span> <span class="o">*</span> <span class="n">D_integral</span><span class="p">)</span>

        <span class="c1"># Handle shear contribution based on mode</span>
        <span class="k">if</span> <span class="n">static_mode</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_static_parameters</span><span class="p">(</span><span class="n">shear_params</span><span class="p">):</span>
            <span class="c1"># Static case: sinc² = 1 (no shear contribution)</span>
            <span class="c1"># g₁(t₁,t₂) = g₁_diff(t₁,t₂) = exp[-q²/2 ∫|t₂-t₁| D(t&#39;)dt&#39;]</span>
            <span class="c1"># g₂(t₁,t₂) = [g₁(t₁,t₂)]²</span>
            <span class="c1"># Note: φ₀ is irrelevant in static mode since shear term is not used</span>
            <span class="n">sinc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Laminar flow case: calculate full sinc² contribution</span>
            <span class="n">gamma_dot_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_shear_rate_optimized</span><span class="p">(</span><span class="n">shear_params</span><span class="p">)</span>
            <span class="n">gamma_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_time_integral_matrix_cached</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;gamma_</span><span class="si">{</span><span class="n">param_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gamma_dot_t</span>
            <span class="p">)</span>

            <span class="c1"># Compute sinc² (shear contribution)</span>
            <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">phi_offset</span> <span class="o">-</span> <span class="n">phi_angle</span><span class="p">)</span>
            <span class="n">cos_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span>
            <span class="n">prefactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sinc_prefactor</span> <span class="o">*</span> <span class="n">cos_phi</span>

            <span class="k">if</span> <span class="n">NUMBA_AVAILABLE</span><span class="p">:</span>
                <span class="n">sinc2</span> <span class="o">=</span> <span class="n">compute_sinc_squared_numba</span><span class="p">(</span><span class="n">gamma_integral</span><span class="p">,</span> <span class="n">prefactor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">prefactor</span> <span class="o">*</span> <span class="n">gamma_integral</span>
                <span class="n">sinc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Combine contributions: c2 = (g1 × sinc²)²</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">sinc2</span> <span class="o">*</span> <span class="n">g1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.calculate_c2_nonequilibrium_laminar_parallel">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.calculate_c2_nonequilibrium_laminar_parallel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_c2_nonequilibrium_laminar_parallel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">phi_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate correlation function for all angles with parallel processing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters : np.ndarray</span>
<span class="sd">            Model parameters</span>
<span class="sd">        phi_angles : np.ndarray</span>
<span class="sd">            Array of scattering angles</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            3D array of correlation matrices [angles, time, time]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_angles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">)</span>
        <span class="n">use_parallel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_parallel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;performance_settings&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;parallel_execution&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>

        <span class="c1"># Avoid threading conflicts with Numba parallel operations</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">or</span> <span class="n">num_angles</span> <span class="o">&lt;</span> <span class="mi">4</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">use_parallel</span>
            <span class="ow">or</span> <span class="n">NUMBA_AVAILABLE</span>
        <span class="p">):</span>
            <span class="c1"># Sequential processing (Numba will handle internal parallelization)</span>
            <span class="n">c2_calculated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="n">num_angles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_angles</span><span class="p">):</span>
                <span class="n">c2_calculated</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_c2_single_angle_optimized</span><span class="p">(</span>
                    <span class="n">parameters</span><span class="p">,</span> <span class="n">phi_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">c2_calculated</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Parallel processing (only when Numba not available)</span>
            <span class="n">use_threading</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">use_threading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;performance_settings&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;use_threading&quot;</span><span class="p">,</span> <span class="kc">True</span>
                <span class="p">)</span>
            <span class="n">Executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span> <span class="k">if</span> <span class="n">use_threading</span> <span class="k">else</span> <span class="n">ProcessPoolExecutor</span>

            <span class="k">with</span> <span class="n">Executor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_c2_single_angle_optimized</span><span class="p">,</span>
                        <span class="n">parameters</span><span class="p">,</span>
                        <span class="n">angle</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">phi_angles</span>
                <span class="p">]</span>

                <span class="n">c2_calculated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">num_angles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_length</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                    <span class="n">c2_calculated</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">c2_calculated</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.calculate_chi_squared_optimized">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.calculate_chi_squared_optimized">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_chi_squared_optimized</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">phi_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">c2_experimental</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">method_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">return_components</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">filter_angles_for_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate chi-squared goodness of fit with per-angle analysis and uncertainty estimation.</span>

<span class="sd">        This method computes the reduced chi-squared statistic for model validation, with optional</span>
<span class="sd">        detailed per-angle analysis and uncertainty quantification. The uncertainty in reduced</span>
<span class="sd">        chi-squared provides insight into the consistency of fit quality across different angles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters : np.ndarray</span>
<span class="sd">            Model parameters [D0, alpha, D_offset, gamma_dot_t0, beta, gamma_dot_t_offset, phi0]</span>
<span class="sd">        phi_angles : np.ndarray</span>
<span class="sd">            Scattering angles in degrees</span>
<span class="sd">        c2_experimental : np.ndarray</span>
<span class="sd">            Experimental correlation data with shape (n_angles, delay_frames, lag_frames)</span>
<span class="sd">        method_name : str, optional</span>
<span class="sd">            Name of optimization method for logging purposes</span>
<span class="sd">        return_components : bool, optional</span>
<span class="sd">            If True, return detailed results dictionary with per-angle analysis</span>
<span class="sd">        filter_angles_for_optimization : bool, optional</span>
<span class="sd">            If True, only include angles in optimization ranges [-10°, 10°] and [170°, 190°]</span>
<span class="sd">            for chi-squared calculation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or dict</span>
<span class="sd">            If return_components=False: Reduced chi-squared value (float)</span>
<span class="sd">            If return_components=True: Dictionary containing:</span>
<span class="sd">                - chi_squared : float</span>
<span class="sd">                    Total chi-squared value</span>
<span class="sd">                - reduced_chi_squared : float</span>
<span class="sd">                    Averaged reduced chi-squared from optimization angles</span>
<span class="sd">                - reduced_chi_squared_uncertainty : float</span>
<span class="sd">                    Standard error of reduced chi-squared across angles (uncertainty estimate)</span>
<span class="sd">                - reduced_chi_squared_std : float</span>
<span class="sd">                    Standard deviation of reduced chi-squared across angles</span>
<span class="sd">                - n_optimization_angles : int</span>
<span class="sd">                    Number of angles used for optimization</span>
<span class="sd">                - degrees_of_freedom : int</span>
<span class="sd">                    Degrees of freedom for statistical testing (data_points - n_parameters)</span>
<span class="sd">                - angle_chi_squared : list</span>
<span class="sd">                    Chi-squared values for each angle</span>
<span class="sd">                - angle_chi_squared_reduced : list</span>
<span class="sd">                    Reduced chi-squared values for each angle</span>
<span class="sd">                - angle_data_points : list</span>
<span class="sd">                    Number of data points per angle</span>
<span class="sd">                - phi_angles : list</span>
<span class="sd">                    Scattering angles used</span>
<span class="sd">                - scaling_solutions : list</span>
<span class="sd">                    Contrast and offset parameters for each angle</span>
<span class="sd">                - valid : bool</span>
<span class="sd">                    Whether calculation was successful</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The uncertainty calculation follows standard error of the mean:</span>
<span class="sd">        </span>
<span class="sd">        reduced_chi2_uncertainty = std(angle_chi2_reduced) / sqrt(n_angles)</span>
<span class="sd">        </span>
<span class="sd">        Interpretation of uncertainty:</span>
<span class="sd">        - Small uncertainty (&lt; 0.1 * reduced_chi2): Consistent fit across angles</span>
<span class="sd">        - Large uncertainty (&gt; 0.5 * reduced_chi2): High angle variability, potential</span>
<span class="sd">          systematic issues or model inadequacy</span>
<span class="sd">        </span>
<span class="sd">        The method uses averaged (not summed) chi-squared for better angle weighting:</span>
<span class="sd">        reduced_chi2 = mean(chi2_reduced_per_angle) for optimization angles only</span>
<span class="sd">        </span>
<span class="sd">        Quality assessment guidelines:</span>
<span class="sd">        - Excellent: reduced_chi2 ≤ 2.0</span>
<span class="sd">        - Acceptable: 2.0 &lt; reduced_chi2 ≤ 5.0  </span>
<span class="sd">        - Warning: 5.0 &lt; reduced_chi2 ≤ 10.0</span>
<span class="sd">        - Poor/Critical: reduced_chi2 &gt; 10.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">OPTIMIZATION_COUNTER</span>

        <span class="c1"># Parameter validation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Configuration not loaded: self.config is None.&quot;</span><span class="p">)</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;advanced_settings&quot;</span><span class="p">][</span><span class="s2">&quot;chi_squared_calculation&quot;</span><span class="p">][</span>
            <span class="s2">&quot;validity_check&quot;</span>
        <span class="p">]</span>

        <span class="n">diffusion_params</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span><span class="p">]</span>
        <span class="n">shear_params</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_diffusion_params</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shear_rate_params</span>
        <span class="p">]</span>

        <span class="c1"># Quick validity checks</span>
        <span class="k">if</span> <span class="n">validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_positive_D0&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">diffusion_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">return_components</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="s2">&quot;chi_squared&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Negative D0&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_positive_gamma_dot_t0&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shear_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">return_components</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="s2">&quot;chi_squared&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Negative gamma_dot_t0&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Check parameter bounds</span>
        <span class="k">if</span> <span class="n">validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_parameter_bounds&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_space&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bounds&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bound</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bounds</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
                    <span class="n">param_val</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">param_min</span> <span class="o">=</span> <span class="n">bound</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                    <span class="n">param_max</span> <span class="o">=</span> <span class="n">bound</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">param_min</span> <span class="o">&lt;=</span> <span class="n">param_val</span> <span class="o">&lt;=</span> <span class="n">param_max</span><span class="p">):</span>
                        <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Parameter </span><span class="si">{</span><span class="n">bound</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                                                        </span><span class="si">}</span><span class="s1"> out of bounds&#39;</span>
                        <span class="k">return</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">return_components</span>
                            <span class="k">else</span> <span class="p">{</span>
                                <span class="s2">&quot;chi_squared&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Calculate theoretical correlation</span>
            <span class="n">c2_theory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_c2_nonequilibrium_laminar_parallel</span><span class="p">(</span>
                <span class="n">parameters</span><span class="p">,</span> <span class="n">phi_angles</span>
            <span class="p">)</span>

            <span class="c1"># Chi-squared calculation</span>
            <span class="n">chi_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;advanced_settings&quot;</span><span class="p">][</span><span class="s2">&quot;chi_squared_calculation&quot;</span><span class="p">]</span>
            <span class="n">uncertainty_factor</span> <span class="o">=</span> <span class="n">chi_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uncertainty_estimation_factor&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="n">min_sigma</span> <span class="o">=</span> <span class="n">chi_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minimum_sigma&quot;</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>

            <span class="c1"># Calculate parameters for DOF calculation</span>
            <span class="n">n_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

            <span class="c1"># Angle filtering for optimization</span>
            <span class="k">if</span> <span class="n">filter_angles_for_optimization</span><span class="p">:</span>
                <span class="c1"># Get target angle ranges from ConfigManager if available</span>
                <span class="n">target_ranges</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">170.0</span><span class="p">,</span> <span class="mf">190.0</span><span class="p">),</span>
                <span class="p">]</span>  <span class="c1"># Default ranges</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;config_manager&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span><span class="p">:</span>
                    <span class="n">target_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span><span class="o">.</span><span class="n">get_target_angle_ranges</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="n">angle_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimization_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;angle_filtering&quot;</span><span class="p">,</span> <span class="p">{}</span>
                    <span class="p">)</span>
                    <span class="n">config_ranges</span> <span class="o">=</span> <span class="n">angle_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_ranges&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="n">config_ranges</span><span class="p">:</span>
                        <span class="n">target_ranges</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_angle&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">),</span>
                                <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_angle&quot;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">config_ranges</span>
                        <span class="p">]</span>

                <span class="c1"># Find indices of angles in target ranges</span>
                <span class="n">optimization_indices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">min_angle</span><span class="p">,</span> <span class="n">max_angle</span> <span class="ow">in</span> <span class="n">target_ranges</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">min_angle</span> <span class="o">&lt;=</span> <span class="n">angle</span> <span class="o">&lt;=</span> <span class="n">max_angle</span><span class="p">:</span>
                            <span class="n">optimization_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">break</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Filtering angles for optimization: using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">optimization_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">)</span><span class="si">}</span><span class="s2"> angles&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">optimization_indices</span><span class="p">:</span>
                    <span class="n">filtered_angles</span> <span class="o">=</span> <span class="n">phi_angles</span><span class="p">[</span><span class="n">optimization_indices</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization angles: </span><span class="si">{</span><span class="n">filtered_angles</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Check if fallback is enabled</span>
                    <span class="n">should_fallback</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;config_manager&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span><span class="p">:</span>
                        <span class="n">should_fallback</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span><span class="o">.</span><span class="n">should_fallback_to_all_angles</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                        <span class="n">angle_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimization_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;angle_filtering&quot;</span><span class="p">,</span> <span class="p">{}</span>
                        <span class="p">)</span>
                        <span class="n">should_fallback</span> <span class="o">=</span> <span class="n">angle_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;fallback_to_all_angles&quot;</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">should_fallback</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;No angles found in target optimization ranges </span><span class="si">{</span><span class="n">target_ranges</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Falling back to using all angles for optimization&quot;</span>
                        <span class="p">)</span>
                        <span class="n">optimization_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">))</span>
                        <span class="p">)</span>  <span class="c1"># Fall back to all angles</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;No angles found in target optimization ranges </span><span class="si">{</span><span class="n">target_ranges</span><span class="si">}</span><span class="s2"> and fallback disabled&quot;</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">optimization_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">)))</span>

            <span class="n">optimization_chi2_angles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">angle_chi2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">angle_chi2_reduced</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">angle_data_points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">scaling_solutions</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Calculate chi-squared for all angles (for detailed results)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">)):</span>
                <span class="n">theory</span> <span class="o">=</span> <span class="n">c2_theory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="n">c2_experimental</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">n_data_angle</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>  <span class="c1"># Number of data points for this angle</span>

                <span class="c1"># SCALING OPTIMIZATION (ALWAYS ENABLED)</span>
                <span class="c1"># =====================================</span>
                <span class="c1"># This performs least squares fitting to determine the optimal scaling relationship:</span>
                <span class="c1"># g₂ = offset + contrast × g₁ where:</span>
                <span class="c1"># - g₁ is the theoretical correlation function </span>
                <span class="c1"># - g₂ is the experimental correlation function</span>
                <span class="c1"># - contrast and offset are fitted scaling parameters</span>
                <span class="c1">#</span>
                <span class="c1"># WHY THIS IS ESSENTIAL:</span>
                <span class="c1"># This scaling optimization is ALWAYS enabled because it is fundamental to proper</span>
                <span class="c1"># chi-squared calculation. Without it, we would compare raw theoretical values </span>
                <span class="c1"># directly to experimental data, which ignores systematic scaling factors and </span>
                <span class="c1"># offsets that are physically present due to:</span>
                <span class="c1"># - Instrumental response functions</span>
                <span class="c1"># - Background signals  </span>
                <span class="c1"># - Detector gain variations</span>
                <span class="c1"># - Normalization differences</span>
                <span class="c1">#</span>
                <span class="c1"># The chi-squared is calculated as χ² = Σ(experimental - fitted)²/σ²</span>
                <span class="c1"># where fitted = theory × contrast + offset from the optimal scaling.</span>
                <span class="c1"># This provides meaningful fitting quality assessment regardless of the number</span>
                <span class="c1"># of scattering angles or analysis mode.</span>
                <span class="c1">#</span>
                <span class="c1"># Mathematical implementation: solve A·x = b where A = [theory, ones], x = [contrast, offset]</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">theory</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theory</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>
                <span class="n">scaling</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scaling</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">contrast</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">scaling</span>
                    <span class="n">fitted</span> <span class="o">=</span> <span class="n">theory</span> <span class="o">*</span> <span class="n">contrast</span> <span class="o">+</span> <span class="n">offset</span>
                    <span class="n">scaling_solutions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">contrast</span><span class="p">,</span> <span class="n">offset</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fitted</span> <span class="o">=</span> <span class="n">theory</span>
                    <span class="n">scaling_solutions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

                <span class="c1"># Calculate chi-squared for this angle</span>
                <span class="n">residuals</span> <span class="o">=</span> <span class="n">exp</span> <span class="o">-</span> <span class="n">fitted</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">*</span> <span class="n">uncertainty_factor</span><span class="p">,</span> <span class="n">min_sigma</span><span class="p">)</span>
                <span class="n">chi2_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residuals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Calculate reduced chi-squared for this angle</span>
                <span class="n">dof_angle</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_data_angle</span> <span class="o">-</span> <span class="n">n_params</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># DOF for this angle</span>
                <span class="n">chi2_reduced_angle</span> <span class="o">=</span> <span class="n">chi2_angle</span> <span class="o">/</span> <span class="n">dof_angle</span>

                <span class="n">angle_chi2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi2_angle</span><span class="p">)</span>
                <span class="n">angle_chi2_reduced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi2_reduced_angle</span><span class="p">)</span>
                <span class="n">angle_data_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_data_angle</span><span class="p">)</span>

                <span class="c1"># Collect chi2 values for optimization angles (for averaging)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_angles_for_optimization</span> <span class="ow">or</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">optimization_indices</span><span class="p">:</span>
                    <span class="n">optimization_chi2_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi2_reduced_angle</span><span class="p">)</span>

            <span class="c1"># Calculate average reduced chi-squared from optimization angles with uncertainty</span>
            <span class="k">if</span> <span class="n">optimization_chi2_angles</span><span class="p">:</span>
                <span class="n">reduced_chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">optimization_chi2_angles</span><span class="p">)</span>
                <span class="n">n_optimization_angles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">optimization_chi2_angles</span><span class="p">)</span>
                
                <span class="c1"># Calculate uncertainty in reduced chi-squared</span>
                <span class="k">if</span> <span class="n">n_optimization_angles</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Standard error of the mean</span>
                    <span class="n">reduced_chi2_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">optimization_chi2_angles</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">reduced_chi2_uncertainty</span> <span class="o">=</span> <span class="n">reduced_chi2_std</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_optimization_angles</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Single angle case</span>
                    <span class="n">reduced_chi2_std</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">reduced_chi2_uncertainty</span> <span class="o">=</span> <span class="mf">0.0</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Using average of </span><span class="si">{</span><span class="n">n_optimization_angles</span><span class="si">}</span><span class="s2"> optimization angles: χ²_red = </span><span class="si">{</span><span class="n">reduced_chi2</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">reduced_chi2_uncertainty</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback if no optimization angles (shouldn&#39;t happen)</span>
                <span class="n">reduced_chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">)</span> <span class="k">if</span> <span class="n">angle_chi2_reduced</span> <span class="k">else</span> <span class="mf">1e6</span>
                <span class="n">reduced_chi2_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="n">reduced_chi2_uncertainty</span> <span class="o">=</span> <span class="n">reduced_chi2_std</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No optimization angles found, using average of all angles&quot;</span><span class="p">)</span>

            <span class="c1"># Logging</span>
            <span class="n">OPTIMIZATION_COUNTER</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">log_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;performance_settings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;optimization_counter_log_frequency&quot;</span><span class="p">,</span> <span class="mi">50</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">OPTIMIZATION_COUNTER</span> <span class="o">%</span> <span class="n">log_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">OPTIMIZATION_COUNTER</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">]: χ²_red = </span><span class="si">{</span><span class="n">reduced_chi2</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">reduced_chi2_uncertainty</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Log reduced chi-square per angle</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">chi2_red_angle</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">,</span> <span class="n">angle_chi2_reduced</span><span class="p">)):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  Angle </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (φ=</span><span class="si">{</span><span class="n">phi</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">°): χ²_red = </span><span class="si">{</span><span class="n">chi2_red_angle</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">return_components</span><span class="p">:</span>
                <span class="c1"># Calculate total chi2 for compatibility (sum of optimization angles)</span>
                <span class="n">total_chi2_compat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">angle_chi2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">optimization_indices</span><span class="p">)</span> <span class="k">if</span> <span class="n">filter_angles_for_optimization</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">angle_chi2</span><span class="p">)</span>
                
                <span class="c1"># Calculate degrees of freedom</span>
                <span class="n">total_data_points</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">angle_data_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">optimization_indices</span><span class="p">)</span> <span class="k">if</span> <span class="n">filter_angles_for_optimization</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">angle_data_points</span><span class="p">)</span>
                <span class="n">num_parameters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
                <span class="n">degrees_of_freedom</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total_data_points</span> <span class="o">-</span> <span class="n">num_parameters</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;chi_squared&quot;</span><span class="p">:</span> <span class="n">total_chi2_compat</span><span class="p">,</span>
                    <span class="s2">&quot;reduced_chi_squared&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">reduced_chi2</span><span class="p">),</span>
                    <span class="s2">&quot;reduced_chi_squared_uncertainty&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">reduced_chi2_uncertainty</span><span class="p">),</span>
                    <span class="s2">&quot;reduced_chi_squared_std&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">reduced_chi2_std</span><span class="p">),</span>
                    <span class="s2">&quot;n_optimization_angles&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">optimization_chi2_angles</span><span class="p">),</span>
                    <span class="s2">&quot;degrees_of_freedom&quot;</span><span class="p">:</span> <span class="n">degrees_of_freedom</span><span class="p">,</span>
                    <span class="s2">&quot;angle_chi_squared&quot;</span><span class="p">:</span> <span class="n">angle_chi2</span><span class="p">,</span>
                    <span class="s2">&quot;angle_chi_squared_reduced&quot;</span><span class="p">:</span> <span class="n">angle_chi2_reduced</span><span class="p">,</span>
                    <span class="s2">&quot;angle_data_points&quot;</span><span class="p">:</span> <span class="n">angle_data_points</span><span class="p">,</span>
                    <span class="s2">&quot;phi_angles&quot;</span><span class="p">:</span> <span class="n">phi_angles</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s2">&quot;scaling_solutions&quot;</span><span class="p">:</span> <span class="n">scaling_solutions</span><span class="p">,</span>
                    <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">reduced_chi2</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chi-squared calculation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Full traceback for chi-squared calculation failure:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_components</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;chi_squared&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.analyze_per_angle_chi_squared">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.analyze_per_angle_chi_squared">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_per_angle_chi_squared</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">phi_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">c2_experimental</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">method_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Final&quot;</span><span class="p">,</span>
        <span class="n">save_to_file</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Comprehensive per-angle reduced chi-squared analysis with quality assessment.</span>

<span class="sd">        This method performs detailed analysis of chi-squared values across different</span>
<span class="sd">        scattering angles, providing quality metrics, uncertainty estimation, and</span>
<span class="sd">        angle categorization to identify systematic fitting issues.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters : np.ndarray</span>
<span class="sd">            Optimized model parameters [D0, alpha, D_offset, gamma_dot_t0, beta, gamma_dot_t_offset, phi0]</span>
<span class="sd">        phi_angles : np.ndarray</span>
<span class="sd">            Scattering angles in degrees</span>
<span class="sd">        c2_experimental : np.ndarray</span>
<span class="sd">            Experimental correlation data with shape (n_angles, delay_frames, lag_frames)</span>
<span class="sd">        method_name : str, optional</span>
<span class="sd">            Name of the analysis method for file naming and logging</span>
<span class="sd">        save_to_file : bool, optional</span>
<span class="sd">            Whether to save detailed results to JSON file</span>
<span class="sd">        output_dir : str, optional</span>
<span class="sd">            Output directory for saved results (defaults to current directory)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Any]</span>
<span class="sd">            Comprehensive analysis results containing:</span>
<span class="sd">                - method : str</span>
<span class="sd">                    Analysis method name</span>
<span class="sd">                - overall_reduced_chi_squared : float</span>
<span class="sd">                    Average reduced chi-squared across optimization angles</span>
<span class="sd">                - reduced_chi_squared_uncertainty : float</span>
<span class="sd">                    Standard error of reduced chi-squared (uncertainty measure)</span>
<span class="sd">                - quality_assessment : dict</span>
<span class="sd">                    Overall and per-angle quality evaluation with thresholds</span>
<span class="sd">                - angle_categorization : dict</span>
<span class="sd">                    Classification of angles into good, unacceptable, and outlier groups</span>
<span class="sd">                - per_angle_analysis : dict</span>
<span class="sd">                    Detailed per-angle chi-squared values and statistics</span>
<span class="sd">                - statistical_summary : dict</span>
<span class="sd">                    Summary statistics including means, medians, and percentiles</span>
<span class="sd">                - recommendations : list</span>
<span class="sd">                    Specific recommendations based on quality assessment</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Quality Assessment Criteria:</span>
<span class="sd">        - Overall reduced chi-squared uncertainty indicates fit consistency:</span>
<span class="sd">          * Small uncertainty (&lt; 10% of chi2): Consistent across angles</span>
<span class="sd">          * Large uncertainty (&gt; 50% of chi2): High variability, investigate systematically</span>
<span class="sd">        </span>
<span class="sd">        Angle Classification:</span>
<span class="sd">        - Good angles: reduced_chi2 ≤ acceptable_threshold (default 5.0)</span>
<span class="sd">        - Unacceptable angles: reduced_chi2 &gt; acceptable_threshold</span>
<span class="sd">        - Statistical outliers: reduced_chi2 &gt; mean + 2.5*std</span>
<span class="sd">        </span>
<span class="sd">        The method uses configuration-driven thresholds from validation_rules.fit_quality</span>
<span class="sd">        for consistent quality assessment across the package.</span>
<span class="sd">        </span>
<span class="sd">        Files saved (if save_to_file=True):</span>
<span class="sd">        - per_angle_chi_squared_{method_name.lower()}.json: Detailed analysis results</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        calculate_chi_squared_optimized : Underlying chi-squared calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get detailed chi-squared components</span>
        <span class="n">chi_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_chi_squared_optimized</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span>
            <span class="n">phi_angles</span><span class="p">,</span>
            <span class="n">c2_experimental</span><span class="p">,</span>
            <span class="n">method_name</span><span class="o">=</span><span class="n">method_name</span><span class="p">,</span>
            <span class="n">return_components</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Handle case where chi_results might be a float (when return_components=False fails)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chi_results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">chi_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Chi-squared calculation failed for per-angle analysis&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Chi-squared calculation failed&quot;</span><span class="p">}</span>

        <span class="c1"># Extract per-angle data</span>
        <span class="n">angle_chi2_reduced</span> <span class="o">=</span> <span class="n">chi_results</span><span class="p">[</span><span class="s2">&quot;angle_chi_squared_reduced&quot;</span><span class="p">]</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">chi_results</span><span class="p">[</span><span class="s2">&quot;phi_angles&quot;</span><span class="p">]</span>

        <span class="c1"># Analysis statistics</span>
        <span class="n">mean_chi2_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">)</span>
        <span class="n">std_chi2_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">)</span>
        <span class="n">min_chi2_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">)</span>
        <span class="n">max_chi2_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">)</span>

        <span class="c1"># Get validation thresholds from configuration</span>
        <span class="n">validation_config</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation_rules&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="n">fit_quality_config</span> <span class="o">=</span> <span class="n">validation_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fit_quality&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">overall_config</span> <span class="o">=</span> <span class="n">fit_quality_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overall_chi_squared&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">per_angle_config</span> <span class="o">=</span> <span class="n">fit_quality_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;per_angle_chi_squared&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Overall reduced chi-squared quality assessment (updated thresholds for reduced chi2)</span>
        <span class="n">overall_chi2</span> <span class="o">=</span> <span class="n">chi_results</span><span class="p">[</span><span class="s2">&quot;reduced_chi_squared&quot;</span><span class="p">]</span>
        <span class="n">excellent_threshold</span> <span class="o">=</span> <span class="n">overall_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;excellent_threshold&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">acceptable_overall</span> <span class="o">=</span> <span class="n">overall_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;acceptable_threshold&quot;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="n">warning_overall</span> <span class="o">=</span> <span class="n">overall_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warning_threshold&quot;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        <span class="n">critical_overall</span> <span class="o">=</span> <span class="n">overall_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;critical_threshold&quot;</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>

        <span class="c1"># Determine overall quality based on reduced chi-squared</span>
        <span class="k">if</span> <span class="n">overall_chi2</span> <span class="o">&lt;=</span> <span class="n">excellent_threshold</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;excellent&quot;</span>
        <span class="k">elif</span> <span class="n">overall_chi2</span> <span class="o">&lt;=</span> <span class="n">acceptable_overall</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;acceptable&quot;</span>
        <span class="k">elif</span> <span class="n">overall_chi2</span> <span class="o">&lt;=</span> <span class="n">warning_overall</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span>
        <span class="k">elif</span> <span class="n">overall_chi2</span> <span class="o">&lt;=</span> <span class="n">critical_overall</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;poor&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overall_quality</span> <span class="o">=</span> <span class="s2">&quot;critical&quot;</span>

        <span class="c1"># Per-angle quality assessment (updated thresholds for reduced chi2)</span>
        <span class="n">excellent_per_angle</span> <span class="o">=</span> <span class="n">per_angle_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;excellent_threshold&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">acceptable_per_angle</span> <span class="o">=</span> <span class="n">per_angle_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;acceptable_threshold&quot;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="n">warning_per_angle</span> <span class="o">=</span> <span class="n">per_angle_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warning_threshold&quot;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        <span class="n">outlier_multiplier</span> <span class="o">=</span> <span class="n">per_angle_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;outlier_threshold_multiplier&quot;</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
        <span class="n">max_outlier_fraction</span> <span class="o">=</span> <span class="n">per_angle_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_outlier_fraction&quot;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
        <span class="n">min_good_angles</span> <span class="o">=</span> <span class="n">per_angle_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_good_angles&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Identify outlier angles using configurable threshold</span>
        <span class="n">outlier_threshold</span> <span class="o">=</span> <span class="n">mean_chi2_red</span> <span class="o">+</span> <span class="n">outlier_multiplier</span> <span class="o">*</span> <span class="n">std_chi2_red</span>
        <span class="n">outlier_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">outlier_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">outlier_angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlier_indices</span><span class="p">]</span>
        <span class="n">outlier_chi2</span> <span class="o">=</span> <span class="p">[</span><span class="n">angle_chi2_reduced</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlier_indices</span><span class="p">]</span>

        <span class="c1"># Categorize angles by quality levels</span>
        <span class="n">angle_chi2_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angle_chi2_reduced</span><span class="p">)</span>
        
        <span class="c1"># Excellent angles (≤ 2.0)</span>
        <span class="n">excellent_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">angle_chi2_array</span> <span class="o">&lt;=</span> <span class="n">excellent_per_angle</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">excellent_angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">excellent_indices</span><span class="p">]</span>
        
        <span class="c1"># Acceptable angles (≤ 5.0)</span>
        <span class="n">acceptable_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">angle_chi2_array</span> <span class="o">&lt;=</span> <span class="n">acceptable_per_angle</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">acceptable_angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">acceptable_indices</span><span class="p">]</span>
        
        <span class="c1"># Warning angles (&gt; 5.0, ≤ 10.0)</span>
        <span class="n">warning_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">angle_chi2_array</span> <span class="o">&gt;</span> <span class="n">acceptable_per_angle</span><span class="p">)</span> <span class="o">&amp;</span> 
            <span class="p">(</span><span class="n">angle_chi2_array</span> <span class="o">&lt;=</span> <span class="n">warning_per_angle</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">warning_angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">warning_indices</span><span class="p">]</span>
        
        <span class="c1"># Poor angles (&gt; 10.0)</span>
        <span class="n">poor_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">angle_chi2_array</span> <span class="o">&gt;</span> <span class="n">warning_per_angle</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">poor_angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">poor_indices</span><span class="p">]</span>
        <span class="n">poor_chi2</span> <span class="o">=</span> <span class="p">[</span><span class="n">angle_chi2_reduced</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">poor_indices</span><span class="p">]</span>
        
        <span class="c1"># Legacy compatibility</span>
        <span class="n">unacceptable_angles</span> <span class="o">=</span> <span class="n">poor_angles</span>
        <span class="n">unacceptable_chi2</span> <span class="o">=</span> <span class="n">poor_chi2</span>
        <span class="n">good_angles</span> <span class="o">=</span> <span class="n">acceptable_angles</span>
        <span class="n">num_good_angles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acceptable_angles</span><span class="p">)</span>

        <span class="c1"># Quality assessment</span>
        <span class="n">outlier_fraction</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlier_angles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
        <span class="n">unacceptable_fraction</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unacceptable_angles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

        <span class="n">per_angle_quality</span> <span class="o">=</span> <span class="s2">&quot;excellent&quot;</span>
        <span class="n">quality_issues</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">num_good_angles</span> <span class="o">&lt;</span> <span class="n">min_good_angles</span><span class="p">:</span>
            <span class="n">per_angle_quality</span> <span class="o">=</span> <span class="s2">&quot;critical&quot;</span>
            <span class="n">quality_issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="n">num_good_angles</span><span class="si">}</span><span class="s2"> good angles (min required: </span><span class="si">{</span><span class="n">min_good_angles</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">unacceptable_fraction</span> <span class="o">&gt;</span> <span class="n">max_outlier_fraction</span><span class="p">:</span>
            <span class="n">per_angle_quality</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;poor&quot;</span> <span class="k">if</span> <span class="n">per_angle_quality</span> <span class="o">!=</span> <span class="s2">&quot;critical&quot;</span> <span class="k">else</span> <span class="n">per_angle_quality</span>
            <span class="p">)</span>
            <span class="n">quality_issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">unacceptable_fraction</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> angles unacceptable (max allowed: </span><span class="si">{</span><span class="n">max_outlier_fraction</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">outlier_fraction</span> <span class="o">&gt;</span> <span class="n">max_outlier_fraction</span><span class="p">:</span>
            <span class="n">per_angle_quality</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;warning&quot;</span> <span class="k">if</span> <span class="n">per_angle_quality</span> <span class="o">==</span> <span class="s2">&quot;excellent&quot;</span> <span class="k">else</span> <span class="n">per_angle_quality</span>
            <span class="p">)</span>
            <span class="n">quality_issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outlier_fraction</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> statistical outliers (max recommended: </span><span class="si">{</span><span class="n">max_outlier_fraction</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Combined assessment</span>
        <span class="k">if</span> <span class="n">overall_quality</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span> <span class="s2">&quot;poor&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">per_angle_quality</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;critical&quot;</span><span class="p">,</span>
            <span class="s2">&quot;poor&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">combined_quality</span> <span class="o">=</span> <span class="s2">&quot;poor&quot;</span>
        <span class="k">elif</span> <span class="n">overall_quality</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span> <span class="ow">or</span> <span class="n">per_angle_quality</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span><span class="p">:</span>
            <span class="n">combined_quality</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span>
        <span class="k">elif</span> <span class="n">overall_quality</span> <span class="o">==</span> <span class="s2">&quot;acceptable&quot;</span> <span class="ow">or</span> <span class="n">per_angle_quality</span> <span class="o">==</span> <span class="s2">&quot;acceptable&quot;</span><span class="p">:</span>
            <span class="n">combined_quality</span> <span class="o">=</span> <span class="s2">&quot;acceptable&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_quality</span> <span class="o">=</span> <span class="s2">&quot;excellent&quot;</span>

        <span class="c1"># Create comprehensive results</span>
        <span class="n">per_angle_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method_name</span><span class="p">,</span>
            <span class="s2">&quot;overall_reduced_chi_squared&quot;</span><span class="p">:</span> <span class="n">chi_results</span><span class="p">[</span><span class="s2">&quot;reduced_chi_squared&quot;</span><span class="p">],</span>
            <span class="s2">&quot;overall_reduced_chi_squared_uncertainty&quot;</span><span class="p">:</span> <span class="n">chi_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduced_chi_squared_uncertainty&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s2">&quot;overall_reduced_chi_squared_std&quot;</span><span class="p">:</span> <span class="n">chi_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduced_chi_squared_std&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s2">&quot;n_optimization_angles&quot;</span><span class="p">:</span> <span class="n">chi_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_optimization_angles&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)),</span>
            <span class="s2">&quot;per_angle_analysis&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;phi_angles_deg&quot;</span><span class="p">:</span> <span class="n">angles</span><span class="p">,</span>
                <span class="s2">&quot;chi_squared_reduced&quot;</span><span class="p">:</span> <span class="n">angle_chi2_reduced</span><span class="p">,</span>
                <span class="s2">&quot;data_points_per_angle&quot;</span><span class="p">:</span> <span class="n">chi_results</span><span class="p">[</span><span class="s2">&quot;angle_data_points&quot;</span><span class="p">],</span>
                <span class="s2">&quot;scaling_solutions&quot;</span><span class="p">:</span> <span class="n">chi_results</span><span class="p">[</span><span class="s2">&quot;scaling_solutions&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;statistics&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;mean_chi2_reduced&quot;</span><span class="p">:</span> <span class="n">mean_chi2_red</span><span class="p">,</span>
                <span class="s2">&quot;std_chi2_reduced&quot;</span><span class="p">:</span> <span class="n">std_chi2_red</span><span class="p">,</span>
                <span class="s2">&quot;min_chi2_reduced&quot;</span><span class="p">:</span> <span class="n">min_chi2_red</span><span class="p">,</span>
                <span class="s2">&quot;max_chi2_reduced&quot;</span><span class="p">:</span> <span class="n">max_chi2_red</span><span class="p">,</span>
                <span class="s2">&quot;range_chi2_reduced&quot;</span><span class="p">:</span> <span class="n">max_chi2_red</span> <span class="o">-</span> <span class="n">min_chi2_red</span><span class="p">,</span>
                <span class="s2">&quot;uncertainty_from_angles&quot;</span><span class="p">:</span> <span class="n">chi_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduced_chi_squared_uncertainty&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;quality_assessment&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;overall_quality&quot;</span><span class="p">:</span> <span class="n">overall_quality</span><span class="p">,</span>
                <span class="s2">&quot;per_angle_quality&quot;</span><span class="p">:</span> <span class="n">per_angle_quality</span><span class="p">,</span>
                <span class="s2">&quot;combined_quality&quot;</span><span class="p">:</span> <span class="n">combined_quality</span><span class="p">,</span>
                <span class="s2">&quot;quality_issues&quot;</span><span class="p">:</span> <span class="n">quality_issues</span><span class="p">,</span>
                <span class="s2">&quot;thresholds_used&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;excellent_overall&quot;</span><span class="p">:</span> <span class="n">excellent_threshold</span><span class="p">,</span>
                    <span class="s2">&quot;acceptable_overall&quot;</span><span class="p">:</span> <span class="n">acceptable_overall</span><span class="p">,</span>
                    <span class="s2">&quot;warning_overall&quot;</span><span class="p">:</span> <span class="n">warning_overall</span><span class="p">,</span>
                    <span class="s2">&quot;critical_overall&quot;</span><span class="p">:</span> <span class="n">critical_overall</span><span class="p">,</span>
                    <span class="s2">&quot;excellent_per_angle&quot;</span><span class="p">:</span> <span class="n">excellent_per_angle</span><span class="p">,</span>
                    <span class="s2">&quot;acceptable_per_angle&quot;</span><span class="p">:</span> <span class="n">acceptable_per_angle</span><span class="p">,</span>
                    <span class="s2">&quot;warning_per_angle&quot;</span><span class="p">:</span> <span class="n">warning_per_angle</span><span class="p">,</span>
                    <span class="s2">&quot;outlier_multiplier&quot;</span><span class="p">:</span> <span class="n">outlier_multiplier</span><span class="p">,</span>
                    <span class="s2">&quot;max_outlier_fraction&quot;</span><span class="p">:</span> <span class="n">max_outlier_fraction</span><span class="p">,</span>
                    <span class="s2">&quot;min_good_angles&quot;</span><span class="p">:</span> <span class="n">min_good_angles</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;interpretation&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;overall_chi2_meaning&quot;</span><span class="p">:</span> <span class="n">_get_chi2_interpretation</span><span class="p">(</span><span class="n">overall_chi2</span><span class="p">),</span>
                    <span class="s2">&quot;quality_explanation&quot;</span><span class="p">:</span> <span class="n">_get_quality_explanation</span><span class="p">(</span><span class="n">combined_quality</span><span class="p">),</span>
                    <span class="s2">&quot;recommended_actions&quot;</span><span class="p">:</span> <span class="n">_get_quality_recommendations</span><span class="p">(</span><span class="n">combined_quality</span><span class="p">,</span> <span class="n">quality_issues</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;angle_categorization&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;excellent_angles&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;angles_deg&quot;</span><span class="p">:</span> <span class="n">excellent_angles</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">excellent_angles</span><span class="p">),</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">excellent_angles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>
                    <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;χ²_red ≤ </span><span class="si">{</span><span class="n">excellent_per_angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;acceptable_angles&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;angles_deg&quot;</span><span class="p">:</span> <span class="n">acceptable_angles</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">acceptable_angles</span><span class="p">),</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">acceptable_angles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>
                    <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;χ²_red ≤ </span><span class="si">{</span><span class="n">acceptable_per_angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;warning_angles&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;angles_deg&quot;</span><span class="p">:</span> <span class="n">warning_angles</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">warning_angles</span><span class="p">),</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">warning_angles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>
                    <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">acceptable_per_angle</span><span class="si">}</span><span class="s2"> &lt; χ²_red ≤ </span><span class="si">{</span><span class="n">warning_per_angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;poor_angles&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;angles_deg&quot;</span><span class="p">:</span> <span class="n">poor_angles</span><span class="p">,</span>
                    <span class="s2">&quot;chi2_reduced&quot;</span><span class="p">:</span> <span class="n">poor_chi2</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">poor_angles</span><span class="p">),</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">poor_angles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>
                    <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;χ²_red &gt; </span><span class="si">{</span><span class="n">warning_per_angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="c1"># Legacy compatibility</span>
                <span class="s2">&quot;good_angles&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;angles_deg&quot;</span><span class="p">:</span> <span class="n">good_angles</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">num_good_angles</span><span class="p">,</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">num_good_angles</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>
                    <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;χ²_red ≤ </span><span class="si">{</span><span class="n">acceptable_per_angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;unacceptable_angles&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;angles_deg&quot;</span><span class="p">:</span> <span class="n">unacceptable_angles</span><span class="p">,</span>
                    <span class="s2">&quot;chi2_reduced&quot;</span><span class="p">:</span> <span class="n">unacceptable_chi2</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">unacceptable_angles</span><span class="p">),</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">unacceptable_fraction</span><span class="p">,</span>
                    <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;χ²_red &gt; </span><span class="si">{</span><span class="n">acceptable_per_angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;statistical_outliers&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;angles_deg&quot;</span><span class="p">:</span> <span class="n">outlier_angles</span><span class="p">,</span>
                    <span class="s2">&quot;chi2_reduced&quot;</span><span class="p">:</span> <span class="n">outlier_chi2</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlier_angles</span><span class="p">),</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">outlier_fraction</span><span class="p">,</span>
                    <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;χ²_red &gt; mean + </span><span class="si">{</span><span class="n">outlier_multiplier</span><span class="si">}</span><span class="s2">×std (</span><span class="si">{</span><span class="n">outlier_threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">),</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Save to file if requested</span>
        <span class="k">if</span> <span class="n">save_to_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output_dir</span> <span class="o">=</span> <span class="s2">&quot;./homodyne_results&quot;</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="n">output_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Save detailed per-angle results</span>
            <span class="n">angle_results_file</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">output_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;per_angle_chi_squared_</span><span class="si">{</span><span class="n">method_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.json&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>  <span class="c1"># noqa: F811</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">angle_results_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">per_angle_results</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Per-angle chi-squared analysis saved to: </span><span class="si">{</span><span class="n">angle_results_file</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save per-angle results: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Log summary with quality assessment</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Per-angle chi-squared analysis [</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">]:&quot;</span><span class="p">)</span>
        <span class="n">overall_uncertainty</span> <span class="o">=</span> <span class="n">chi_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reduced_chi_squared_uncertainty&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overall_uncertainty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Overall χ²_red: </span><span class="si">{</span><span class="n">chi_results</span><span class="p">[</span><span class="s1">&#39;reduced_chi_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">overall_uncertainty</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">overall_quality</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Overall χ²_red: </span><span class="si">{</span><span class="n">chi_results</span><span class="p">[</span><span class="s1">&#39;reduced_chi_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">overall_quality</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  Mean per-angle χ²_red: </span><span class="si">{</span><span class="n">mean_chi2_red</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">std_chi2_red</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Range: </span><span class="si">{</span><span class="n">min_chi2_red</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">max_chi2_red</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Quality assessment logging</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Quality Assessment: </span><span class="si">{</span><span class="n">combined_quality</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;    Overall: </span><span class="si">{</span><span class="n">overall_quality</span><span class="si">}</span><span class="s2"> (threshold: </span><span class="si">{</span><span class="n">acceptable_overall</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Per-angle: </span><span class="si">{</span><span class="n">per_angle_quality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Angle categorization</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Angle Categorization:&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;    Good angles: </span><span class="si">{</span><span class="n">num_good_angles</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">num_good_angles</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%) [χ²_red ≤ </span><span class="si">{</span><span class="n">acceptable_per_angle</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;    Unacceptable angles: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unacceptable_angles</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">unacceptable_fraction</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%) [χ²_red &gt; </span><span class="si">{</span><span class="n">acceptable_per_angle</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;    Statistical outliers: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outlier_angles</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">outlier_fraction</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%) [χ²_red &gt; </span><span class="si">{</span><span class="n">outlier_threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Warnings and issues</span>
        <span class="k">if</span> <span class="n">quality_issues</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">quality_issues</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Quality Issue: </span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unacceptable_angles</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unacceptable angles: </span><span class="si">{</span><span class="n">unacceptable_angles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outlier_angles</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Statistical outlier angles: </span><span class="si">{</span><span class="n">outlier_angles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Overall quality verdict</span>
        <span class="k">if</span> <span class="n">combined_quality</span> <span class="o">==</span> <span class="s2">&quot;critical&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;  ❌ CRITICAL: Fit quality is unacceptable - consider parameter adjustment or data quality check&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">combined_quality</span> <span class="o">==</span> <span class="s2">&quot;poor&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;  ⚠ POOR: Fit quality is poor - optimization may need improvement&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">combined_quality</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;  ⚠ WARNING: Some angles show poor fit - consider investigation&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">combined_quality</span> <span class="o">==</span> <span class="s2">&quot;acceptable&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;  ✓ ACCEPTABLE: Fit quality is acceptable with some limitations&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  ✅ EXCELLENT: Fit quality is excellent across all angles&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">per_angle_results</span></div>


<div class="viewcode-block" id="HomodyneAnalysisCore.save_results_with_config">
<a class="viewcode-back" href="../../../api/homodyne.analysis.html#homodyne.HomodyneAnalysisCore.save_results_with_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_results_with_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save optimization results along with configuration to JSON file.</span>
<span class="sd">        </span>
<span class="sd">        This method ensures all results including uncertainty fields are properly</span>
<span class="sd">        saved with the configuration for reproducibility.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        results : Dict[str, Any]</span>
<span class="sd">            Results dictionary from optimization methods</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
        
        <span class="c1"># Create comprehensive results with configuration</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        
        <span class="n">output_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span>
        <span class="p">}</span>
        
        <span class="c1"># Add execution metadata</span>
        <span class="k">if</span> <span class="s2">&quot;execution_metadata&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_data</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">[</span><span class="s2">&quot;execution_metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;analysis_success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span>
            <span class="p">}</span>
        
        <span class="c1"># Determine output file name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_settings&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">file_formats</span> <span class="o">=</span> <span class="n">output_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_formats&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">results_format</span> <span class="o">=</span> <span class="n">file_formats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results_format&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results_format</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>
        
        <span class="k">if</span> <span class="n">results_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="s2">&quot;homodyne_analysis_results.json&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;homodyne_analysis_results.</span><span class="si">{</span><span class="n">results_format</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Save to JSON format regardless of specified format for compatibility</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results and configuration saved to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Also save a copy to results directory if it exists</span>
            <span class="n">results_dir</span> <span class="o">=</span> <span class="s2">&quot;homodyne_analysis_results&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">results_dir</span><span class="p">):</span>
                <span class="n">results_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="s2">&quot;run_configuration.json&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results also saved to </span><span class="si">{</span><span class="n">results_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save results: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        
        <span class="c1"># Generate plots if enabled in configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_analysis_plots</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_data</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_experimental_data_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c2_experimental</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">phi_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot experimental C2 data immediately after loading for validation.</span>
<span class="sd">        </span>
<span class="sd">        This method creates a comprehensive validation plot of the loaded experimental</span>
<span class="sd">        data to verify data integrity and structure before analysis.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c2_experimental : np.ndarray</span>
<span class="sd">            Experimental correlation data with shape (n_angles, n_t2, n_t1)</span>
<span class="sd">        phi_angles : np.ndarray</span>
<span class="sd">            Array of scattering angles in degrees</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Import plotting dependencies</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gridspec</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating experimental data validation plot&quot;</span><span class="p">)</span>
            
            <span class="c1"># Set up plotting style</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
                <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                <span class="s1">&#39;figure.dpi&#39;</span><span class="p">:</span> <span class="mi">150</span>
            <span class="p">})</span>
            
            <span class="c1"># Get temporal parameters</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">n_angles</span><span class="p">,</span> <span class="n">n_t2</span><span class="p">,</span> <span class="n">n_t1</span> <span class="o">=</span> <span class="n">c2_experimental</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">time_t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_t2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="n">time_t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_t1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape for validation plot: </span><span class="si">{</span><span class="n">c2_experimental</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time parameters: dt=</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">, t2_max=</span><span class="si">{</span><span class="n">time_t2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s, t1_max=</span><span class="si">{</span><span class="n">time_t1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
            
            <span class="c1"># Create the validation plot</span>
            <span class="n">n_plot_angles</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_angles</span><span class="p">)</span>  <span class="c1"># Show up to 3 angles</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">n_plot_angles</span><span class="p">))</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_plot_angles</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plot_angles</span><span class="p">):</span>
                <span class="n">angle_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_angles</span> <span class="o">//</span> <span class="n">n_plot_angles</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_angles</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">angle_idx</span> <span class="o">&gt;=</span> <span class="n">n_angles</span><span class="p">:</span>
                    <span class="n">angle_idx</span> <span class="o">=</span> <span class="n">n_angles</span> <span class="o">-</span> <span class="mi">1</span>
                    
                <span class="n">angle_data</span> <span class="o">=</span> <span class="n">c2_experimental</span><span class="p">[</span><span class="n">angle_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">phi_deg</span> <span class="o">=</span> <span class="n">phi_angles</span><span class="p">[</span><span class="n">angle_idx</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">angle_idx</span> <span class="k">else</span> <span class="mf">0.0</span>
                
                <span class="c1"># 1. Full heatmap</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">im1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">angle_data</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                               <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">time_t1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_t1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">time_t2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_t2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="c1"># type: ignore</span>
                               <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time t₁ (s)&#39;</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Time t₂ (s)&#39;</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;g₂(t₁,t₂) at φ=</span><span class="si">{</span><span class="n">phi_deg</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">°&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                
                <span class="c1"># 2. Diagonal slice</span>
                <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">diagonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">angle_data</span><span class="p">)</span>
                <span class="n">time_diag</span> <span class="o">=</span> <span class="n">time_t1</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)]</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_diag</span><span class="p">,</span> <span class="n">diagonal</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;g₂(t,t)&#39;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Diagonal at φ=</span><span class="si">{</span><span class="n">phi_deg</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">°&#39;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                
                <span class="c1"># 3. Cross-sections</span>
                <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">n_sections</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">section_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_t2</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_sections</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>
                
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">section_indices</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n_t2</span><span class="p">:</span>
                        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_t1</span><span class="p">,</span> <span class="n">angle_data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> 
                               <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;t₂=</span><span class="si">{</span><span class="n">time_t2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
                
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time t₁ (s)&#39;</span><span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;g₂(t₁,t₂)&#39;</span><span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cross-sections at φ=</span><span class="si">{</span><span class="n">phi_deg</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">°&#39;</span><span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                
                <span class="c1"># 4. Statistics</span>
                <span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                
                <span class="c1"># Calculate statistics</span>
                <span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">angle_data</span><span class="p">)</span>
                <span class="n">std_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">angle_data</span><span class="p">)</span>
                <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">angle_data</span><span class="p">)</span>
                <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">angle_data</span><span class="p">)</span>
                <span class="n">diag_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span>
                <span class="n">contrast</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">min_val</span>
                
                <span class="n">stats_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Data Statistics (φ=</span><span class="si">{</span><span class="n">phi_deg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">°):</span>

<span class="s2">Shape: </span><span class="si">{</span><span class="n">angle_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> × </span><span class="si">{</span><span class="n">angle_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span>

<span class="s2">g₂ Values:</span>
<span class="s2">Mean: </span><span class="si">{</span><span class="n">mean_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">Std:  </span><span class="si">{</span><span class="n">std_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">Min:  </span><span class="si">{</span><span class="n">min_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">Max:  </span><span class="si">{</span><span class="n">max_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>

<span class="s2">Diagonal mean: </span><span class="si">{</span><span class="n">diag_mean</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">Contrast: </span><span class="si">{</span><span class="n">contrast</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Validation:</span>
<span class="si">{</span><span class="s1">&#39;✓&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="mf">0.9</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mean_val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1.2</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;✗&#39;</span><span class="si">}</span><span class="s2"> Mean around 1.0</span>
<span class="si">{</span><span class="s1">&#39;✓&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">diag_mean</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mean_val</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;✗&#39;</span><span class="si">}</span><span class="s2"> Diagonal enhanced</span>
<span class="si">{</span><span class="s1">&#39;✓&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">contrast</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.001</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;✗&#39;</span><span class="si">}</span><span class="s2"> Sufficient contrast&quot;&quot;&quot;</span>
                
                <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">stats_text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                        <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontfamily</span><span class="o">=</span><span class="s1">&#39;monospace&#39;</span><span class="p">,</span>
                        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">))</span>
            
            <span class="c1"># Overall title</span>
            <span class="n">sample_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_description&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown Sample&#39;</span><span class="p">)</span> <span class="c1"># type: ignore</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Experimental Data Validation: </span><span class="si">{</span><span class="n">sample_desc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            
            <span class="c1"># Save the validation plot</span>
            <span class="n">plots_base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_settings&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plotting&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_directory&quot;</span><span class="p">,</span> <span class="s2">&quot;./plots&quot;</span><span class="p">)</span> <span class="c1"># type: ignore</span>
            <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">plots_base_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;data_validation&quot;</span>
            <span class="n">plots_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">plots_dir</span> <span class="o">/</span> <span class="s2">&quot;experimental_data_validation.png&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experimental data validation plot saved to: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Optionally show the plot</span>
            <span class="n">show_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_settings&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plotting&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;general&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;show_plots&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create experimental data validation plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_analysis_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">output_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate analysis plots including C2 heatmaps with experimental vs theoretical comparison.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        results : Dict[str, Any]</span>
<span class="sd">            Results dictionary from optimization methods</span>
<span class="sd">        output_data : Dict[str, Any]</span>
<span class="sd">            Complete output data including configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        
        <span class="c1"># Check if plotting is enabled in configuration</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">output_settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_settings&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">reporting</span> <span class="o">=</span> <span class="n">output_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reporting&quot;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reporting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generate_plots&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting disabled in configuration - skipping plot generation&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating analysis plots...&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Import plotting module</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">plot_c2_heatmaps</span><span class="p">,</span> <span class="n">plot_diagnostic_summary</span><span class="p">,</span>
                <span class="n">plot_mcmc_corner</span><span class="p">,</span> <span class="n">plot_mcmc_trace</span><span class="p">,</span> <span class="n">plot_mcmc_convergence_diagnostics</span>
            <span class="p">)</span>
            
            <span class="c1"># Determine output directory</span>
            <span class="n">results_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;homodyne_results&quot;</span><span class="p">)</span>
            <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">results_dir</span> <span class="o">/</span> <span class="s2">&quot;plots&quot;</span>
            <span class="n">plots_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Prepare data for plotting</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_plot_data</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">plot_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Insufficient data for plotting - skipping plot generation&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Generate C2 heatmaps if experimental and theoretical data are available</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">plot_data</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">,</span> <span class="s2">&quot;theoretical_data&quot;</span><span class="p">,</span> <span class="s2">&quot;phi_angles&quot;</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating C2 correlation heatmaps...&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">plot_c2_heatmaps</span><span class="p">(</span>
                        <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">],</span>
                        <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;theoretical_data&quot;</span><span class="p">],</span> 
                        <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;phi_angles&quot;</span><span class="p">],</span>
                        <span class="n">plots_dir</span><span class="p">,</span>
                        <span class="n">config</span><span class="p">,</span>
                        <span class="n">t2</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t2&quot;</span><span class="p">),</span>
                        <span class="n">t1</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✓ C2 heatmaps generated successfully&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠ Some C2 heatmaps failed to generate&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate C2 heatmaps: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Parameter evolution plot - DISABLED (was non-functional)</span>
            <span class="c1"># This plot has been removed due to persistent issues</span>
            
            <span class="c1"># Generate MCMC plots if trace data is available</span>
            <span class="k">if</span> <span class="s2">&quot;mcmc_trace&quot;</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating MCMC plots...&quot;</span><span class="p">)</span>
                
                <span class="c1"># MCMC corner plot</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">plot_mcmc_corner</span><span class="p">(</span>
                        <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;mcmc_trace&quot;</span><span class="p">],</span>
                        <span class="n">plots_dir</span><span class="p">,</span>
                        <span class="n">config</span><span class="p">,</span>
                        <span class="n">param_names</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">),</span>
                        <span class="n">param_units</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_units&quot;</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✓ MCMC corner plot generated successfully&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠ MCMC corner plot failed to generate&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate MCMC corner plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># MCMC trace plots</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">plot_mcmc_trace</span><span class="p">(</span>
                        <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;mcmc_trace&quot;</span><span class="p">],</span>
                        <span class="n">plots_dir</span><span class="p">,</span>
                        <span class="n">config</span><span class="p">,</span>
                        <span class="n">param_names</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">),</span>
                        <span class="n">param_units</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_units&quot;</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✓ MCMC trace plots generated successfully&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠ MCMC trace plots failed to generate&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate MCMC trace plots: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># MCMC convergence diagnostics</span>
                <span class="k">if</span> <span class="s2">&quot;mcmc_diagnostics&quot;</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="n">plot_mcmc_convergence_diagnostics</span><span class="p">(</span>
                            <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;mcmc_trace&quot;</span><span class="p">],</span>
                            <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;mcmc_diagnostics&quot;</span><span class="p">],</span>
                            <span class="n">plots_dir</span><span class="p">,</span>
                            <span class="n">config</span><span class="p">,</span>
                            <span class="n">param_names</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✓ MCMC convergence diagnostics generated successfully&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠ MCMC convergence diagnostics failed to generate&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate MCMC convergence diagnostics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MCMC trace data not available - skipping MCMC plots&quot;</span><span class="p">)</span>

            <span class="c1"># Generate diagnostic summary plot</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating diagnostic summary plot...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="n">plot_diagnostic_summary</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="n">plots_dir</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✓ Diagnostic summary plot generated successfully&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠ Diagnostic summary plot failed to generate&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate diagnostic summary plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plots saved to: </span><span class="si">{</span><span class="n">plots_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting module not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Install matplotlib for plotting: pip install matplotlib&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during plot generation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare data for plotting from analysis results.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        results : Dict[str, Any]</span>
<span class="sd">            Results dictionary from optimization methods</span>
<span class="sd">        config : Dict[str, Any]</span>
<span class="sd">            Configuration dictionary</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[Dict[str, Any]]</span>
<span class="sd">            Plot data dictionary or None if insufficient data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># Find the best method results</span>
            <span class="n">best_method</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">best_chi2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            
            <span class="c1"># Check different method results</span>
            <span class="k">for</span> <span class="n">method_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;classical_optimization&quot;</span><span class="p">,</span> <span class="s2">&quot;mcmc_optimization&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">method_key</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">method_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">method_key</span><span class="p">]</span>
                    <span class="n">chi2</span> <span class="o">=</span> <span class="n">method_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chi_squared&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="o">&lt;</span> <span class="n">best_chi2</span><span class="p">:</span>
                        <span class="n">best_chi2</span> <span class="o">=</span> <span class="n">chi2</span>
                        <span class="n">best_method</span> <span class="o">=</span> <span class="n">method_key</span>
            
            <span class="k">if</span> <span class="n">best_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid optimization results found for plotting&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="c1"># Extract best parameters</span>
            <span class="n">best_params_list</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_method</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_params_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Convert parameter list to dictionary</span>
                <span class="n">param_names</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_parameters&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_params_list</span><span class="p">):</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;best_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">best_params_list</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Use generic names if parameter names don&#39;t match</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;best_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;param_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">best_params_list</span><span class="p">)}</span>
            
            <span class="c1"># Extract parameter bounds</span>
            <span class="n">parameter_space</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_space&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">parameter_space</span><span class="p">:</span>
                <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;parameter_bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_space</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span>
            
            <span class="c1"># Extract initial parameters</span>
            <span class="n">initial_params</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_parameters&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;values&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_names</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_parameters&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_params</span><span class="p">):</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;initial_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">initial_params</span><span class="p">))</span>
            
            <span class="c1"># Try to reconstruct experimental and theoretical data for plotting</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_last_experimental_data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_last_phi_angles&#39;</span><span class="p">):</span>
                <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_experimental_data</span>
                <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;phi_angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_phi_angles</span>
                
                <span class="c1"># Generate theoretical data using best parameters</span>
                <span class="k">if</span> <span class="n">best_params_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">theoretical_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_theoretical_data</span><span class="p">(</span><span class="n">best_params_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_phi_angles</span><span class="p">)</span> <span class="c1"># type: ignore</span>
                        <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;theoretical_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theoretical_data</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate theoretical data for plotting: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Add time axes if available</span>
            <span class="n">temporal</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analyzer_parameters&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temporal&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">temporal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="n">start_frame</span> <span class="o">=</span> <span class="n">temporal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_frame&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">end_frame</span> <span class="o">=</span> <span class="n">temporal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_frame&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            
            <span class="c1"># Generate time arrays (these are approximate)</span>
            <span class="n">n_frames</span> <span class="o">=</span> <span class="n">end_frame</span> <span class="o">-</span> <span class="n">start_frame</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">t_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_frames</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;t1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_array</span>
            <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;t2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_array</span>
            
            <span class="c1"># Add parameter names and units for MCMC plotting</span>
            <span class="n">param_names</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_parameters&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">param_names</span><span class="p">:</span>
                <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_names</span>
                
            <span class="c1"># Extract parameter units from bounds configuration</span>
            <span class="n">parameter_space</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_space&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">parameter_space</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bounds&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">bounds</span><span class="p">:</span>
                <span class="n">param_units</span> <span class="o">=</span> <span class="p">[</span><span class="n">bound</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">]</span>
                <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;parameter_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_units</span>
            
            <span class="c1"># Add MCMC-specific data if available</span>
            <span class="k">if</span> <span class="s2">&quot;mcmc_optimization&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">mcmc_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mcmc_optimization&quot;</span><span class="p">]</span>
                
                <span class="c1"># Add convergence diagnostics</span>
                <span class="k">if</span> <span class="s2">&quot;convergence_diagnostics&quot;</span> <span class="ow">in</span> <span class="n">mcmc_results</span><span class="p">:</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;mcmc_diagnostics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcmc_results</span><span class="p">[</span><span class="s2">&quot;convergence_diagnostics&quot;</span><span class="p">]</span>
                
                <span class="c1"># Add posterior means</span>
                <span class="k">if</span> <span class="s2">&quot;posterior_means&quot;</span> <span class="ow">in</span> <span class="n">mcmc_results</span><span class="p">:</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcmc_results</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">]</span>
                    
                <span class="c1"># Try to get MCMC trace data from live results first</span>
                <span class="n">trace_data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="s2">&quot;trace&quot;</span> <span class="ow">in</span> <span class="n">mcmc_results</span> <span class="ow">and</span> <span class="n">mcmc_results</span><span class="p">[</span><span class="s2">&quot;trace&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">trace_data</span> <span class="o">=</span> <span class="n">mcmc_results</span><span class="p">[</span><span class="s2">&quot;trace&quot;</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using live MCMC trace data for plotting&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;trace&quot;</span> <span class="ow">in</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;trace&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Check top-level trace data as fallback</span>
                    <span class="n">trace_data</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;trace&quot;</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using top-level MCMC trace data for plotting&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Final fallback: try to load from NetCDF file</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
                        <span class="n">mcmc_results_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;homodyne_results&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;mcmc_results&quot;</span>
                        <span class="n">trace_file</span> <span class="o">=</span> <span class="n">mcmc_results_dir</span> <span class="o">/</span> <span class="s2">&quot;mcmc_trace.nc&quot;</span>
                        
                        <span class="k">if</span> <span class="n">trace_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">import</span><span class="w"> </span><span class="nn">arviz</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">az</span>
                                <span class="n">trace_data</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_netcdf</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">trace_file</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded MCMC trace data from </span><span class="si">{</span><span class="n">trace_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ArviZ not available - cannot load MCMC trace for plotting&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load MCMC trace data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MCMC trace file not found&quot;</span><span class="p">)</span>
                            
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking for MCMC trace file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Add trace data to plot_data if found</span>
                <span class="k">if</span> <span class="n">trace_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;mcmc_trace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_data</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✓ MCMC trace data available for plotting&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MCMC trace data not available - trace plots will be skipped&quot;</span><span class="p">)</span>
            
            <span class="c1"># Add other plot data</span>
            <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;chi_squared&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_chi2</span>
            <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_method</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_optimization&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">plot_data</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error preparing plot data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_theoretical_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">phi_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate theoretical correlation data for plotting.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters : list</span>
<span class="sd">            Optimized parameters</span>
<span class="sd">        phi_angles : np.ndarray</span>
<span class="sd">            Array of phi angles</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Theoretical correlation data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the existing physics model to generate theoretical data</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating theoretical data for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">)</span><span class="si">}</span><span class="s2"> angles&quot;</span><span class="p">)</span>
            
            <span class="c1"># Call the main correlation calculation method</span>
            <span class="n">theoretical_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_c2_nonequilibrium_laminar_parallel</span><span class="p">(</span>
                <span class="n">parameters</span><span class="p">,</span> <span class="n">phi_angles</span> <span class="c1"># type: ignore</span>
            <span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully generated theoretical data with shape: </span><span class="si">{</span><span class="n">theoretical_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">theoretical_data</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating theoretical data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback: return experimental data shape filled with ones if available</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_last_experimental_data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_experimental_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_experimental_data</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using fallback data with shape </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No fallback data available&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_get_chi2_interpretation</span><span class="p">(</span><span class="n">chi2_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide interpretation of reduced chi-squared value with uncertainty context.</span>
<span class="sd">    </span>
<span class="sd">    The reduced chi-squared uncertainty quantifies the reliability of the average:</span>
<span class="sd">    - Small uncertainty (&lt; 0.1 * χ²_red): Consistent fit quality across angles</span>
<span class="sd">    - Moderate uncertainty (0.1-0.5 * χ²_red): Some angle variation, generally acceptable</span>
<span class="sd">    - Large uncertainty (&gt; 0.5 * χ²_red): High variability between angles, potential systematic issues</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chi2_value : float</span>
<span class="sd">        Reduced chi-squared value</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Interpretation string with quality assessment and statistical meaning</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">chi2_value</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Excellent fit (χ²_red = </span><span class="si">{</span><span class="n">chi2_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ≤ 1.0): Model matches data within expected noise&quot;</span>
    <span class="k">elif</span> <span class="n">chi2_value</span> <span class="o">&lt;=</span> <span class="mf">2.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Very good fit (χ²_red = </span><span class="si">{</span><span class="n">chi2_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">): Model captures main features with minor deviations&quot;</span>
    <span class="k">elif</span> <span class="n">chi2_value</span> <span class="o">&lt;=</span> <span class="mf">5.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Acceptable fit (χ²_red = </span><span class="si">{</span><span class="n">chi2_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">): Model reasonable but some systematic deviations present&quot;</span>
    <span class="k">elif</span> <span class="n">chi2_value</span> <span class="o">&lt;=</span> <span class="mf">10.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Poor fit (χ²_red = </span><span class="si">{</span><span class="n">chi2_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">): Significant deviations suggest model inadequacy or underestimated uncertainties&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Very poor fit (χ²_red = </span><span class="si">{</span><span class="n">chi2_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">): Major systematic deviations, model likely inappropriate&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_quality_explanation</span><span class="p">(</span><span class="n">quality</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide explanation of quality assessment.&quot;&quot;&quot;</span>
    <span class="n">explanations</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;excellent&quot;</span><span class="p">:</span> <span class="s2">&quot;Model provides exceptional agreement with experimental data across all angles&quot;</span><span class="p">,</span>
        <span class="s2">&quot;acceptable&quot;</span><span class="p">:</span> <span class="s2">&quot;Model provides reasonable agreement with experimental data for most angles&quot;</span><span class="p">,</span>
        <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="s2">&quot;Model shows concerning deviations that may indicate systematic issues&quot;</span><span class="p">,</span>
        <span class="s2">&quot;poor&quot;</span><span class="p">:</span> <span class="s2">&quot;Model shows significant inadequacies in describing the experimental data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;critical&quot;</span><span class="p">:</span> <span class="s2">&quot;Model is fundamentally inappropriate for this dataset&quot;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">explanations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quality</span><span class="p">,</span> <span class="s2">&quot;Unknown quality level&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_quality_recommendations</span><span class="p">(</span><span class="n">quality</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">issues</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide actionable recommendations based on quality assessment.&quot;&quot;&quot;</span>
    <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">quality</span> <span class="o">==</span> <span class="s2">&quot;excellent&quot;</span><span class="p">:</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Results are reliable for publication&quot;</span><span class="p">)</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Consider this model for further analysis&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">quality</span> <span class="o">==</span> <span class="s2">&quot;acceptable&quot;</span><span class="p">:</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Results may be suitable with appropriate caveats&quot;</span><span class="p">)</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Consider checking specific angles with higher chi-squared&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">quality</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span><span class="p">:</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Investigate systematic deviations before publication&quot;</span><span class="p">)</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Consider alternative models or parameter ranges&quot;</span><span class="p">)</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Check experimental uncertainties and data quality&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">quality</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;poor&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">]:</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Do not use results for quantitative conclusions&quot;</span><span class="p">)</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Consider fundamental model revision&quot;</span><span class="p">)</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Check experimental setup and data processing&quot;</span><span class="p">)</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Investigate alternative theoretical approaches&quot;</span><span class="p">)</span>
    
    <span class="c1"># Add issue-specific recommendations</span>
    <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;outliers&quot;</span> <span class="ow">in</span> <span class="n">issue</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Investigate outlier angles for experimental artifacts&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;good angles&quot;</span> <span class="ow">in</span> <span class="n">issue</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Consider focusing analysis on subset of reliable angles&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">recommendations</span>


<span class="c1"># ============================================================================</span>
<span class="c1"># PARAMETER MANAGEMENT AND RESULTS SAVING</span>
<span class="c1"># ============================================================================</span>

<span class="c1"># Note: Additional methods would be defined here if needed</span>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Wei Chen, Hongrui He.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>