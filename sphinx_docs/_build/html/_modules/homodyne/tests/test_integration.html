

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>homodyne.tests.test_integration &mdash; Homodyne Analysis 6.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=66ead900" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=54d05895"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980b9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Homodyne Analysis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analysis_modes.html">Analysis Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Configuration System</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../optimization_methods.html">Optimization Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scaling_optimization.html">Scaling Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance.html">Performance Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_validation.html">Data Validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">homodyne</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">Testing and Quality Assurance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980b9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Homodyne Analysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">homodyne.tests.test_integration</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for homodyne.tests.test_integration</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Integration Tests for Rheo-SAXS-XPCS Analysis</span>
<span class="sd">=============================================</span>

<span class="sd">Tests complete analysis workflow with mocked heavy computations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">mock_open</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># Import the modules to test</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.tests.fixtures</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">dummy_config</span><span class="p">,</span>
    <span class="n">dummy_correlation_data</span><span class="p">,</span>
    <span class="n">dummy_theoretical_data</span><span class="p">,</span>
    <span class="n">dummy_phi_angles</span><span class="p">,</span>
    <span class="n">dummy_analysis_results</span><span class="p">,</span>
    <span class="n">temp_directory</span><span class="p">,</span>
    <span class="n">create_minimal_config_file</span><span class="p">,</span>
    <span class="n">mock_optimization_result</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Import modules being tested</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.core.io_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">save_analysis_results</span><span class="p">,</span>
        <span class="n">ensure_dir</span><span class="p">,</span>
        <span class="n">get_output_directory</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">IO_UTILS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">IO_UTILS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Provide fallback functions for type checker</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_analysis_results</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;IO utils not available&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_dir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Return a Path object that behaves correctly for tests</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_directory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_all_plots</span>

    <span class="n">PLOTTING_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PLOTTING_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Provide fallback function for type checker</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_all_plots</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.analysis.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">HomodyneAnalysisCore</span>

    <span class="n">CORE_ANALYSIS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">CORE_ANALYSIS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="TestCompleteWorkflow">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestCompleteWorkflow">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestCompleteWorkflow</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test complete analysis workflow integration.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestCompleteWorkflow.test_full_analysis_pipeline">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestCompleteWorkflow.test_full_analysis_pipeline">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span>
        <span class="ow">not</span> <span class="p">(</span><span class="n">IO_UTILS_AVAILABLE</span> <span class="ow">and</span> <span class="n">PLOTTING_AVAILABLE</span><span class="p">),</span>
        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Required modules not available&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_full_analysis_pipeline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_analysis_results</span><span class="p">,</span> <span class="n">dummy_config</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test complete pipeline: data processing → analysis → plotting → saving.&quot;&quot;&quot;</span>
        <span class="c1"># Set up output directory in temp space</span>
        <span class="n">dummy_config</span><span class="p">[</span><span class="s2">&quot;output_settings&quot;</span><span class="p">][</span><span class="s2">&quot;results_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;full_pipeline&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Step 1: Create output directories</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">get_output_directory</span><span class="p">(</span><span class="n">dummy_config</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

        <span class="c1"># Step 2: Save analysis results</span>
        <span class="n">save_status</span> <span class="o">=</span> <span class="n">save_analysis_results</span><span class="p">(</span>
            <span class="n">dummy_analysis_results</span><span class="p">,</span> <span class="n">dummy_config</span><span class="p">,</span> <span class="s2">&quot;integration_test&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">save_status</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>

        <span class="c1"># Step 3: Create plots</span>
        <span class="n">plot_status</span> <span class="o">=</span> <span class="n">create_all_plots</span><span class="p">(</span>
            <span class="n">dummy_analysis_results</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">dummy_config</span>
        <span class="p">)</span>
        <span class="n">successful_plots</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">plot_status</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">status</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">successful_plots</span> <span class="o">&gt;=</span> <span class="mi">1</span>

        <span class="c1"># Step 4: Verify all outputs exist</span>
        <span class="n">json_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">))</span>
        <span class="n">plot_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.png&quot;</span><span class="p">))</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>

        <span class="c1"># Verify JSON content is readable</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">saved_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">saved_results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s2">&quot;best_chi_squared&quot;</span> <span class="ow">in</span> <span class="n">saved_results</span></div>


<div class="viewcode-block" id="TestCompleteWorkflow.test_directory_creation_workflow">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestCompleteWorkflow.test_directory_creation_workflow">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_directory_creation_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that the entire directory structure is created correctly.&quot;&quot;&quot;</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;analysis_workspace&quot;</span>

        <span class="c1"># Test nested directory creation</span>
        <span class="n">required_dirs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;results&quot;</span><span class="p">,</span>
            <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;plots&quot;</span> <span class="o">/</span> <span class="s2">&quot;c2_heatmaps&quot;</span><span class="p">,</span>
            <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;plots&quot;</span> <span class="o">/</span> <span class="s2">&quot;parameters&quot;</span><span class="p">,</span>
            <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;plots&quot;</span> <span class="o">/</span> <span class="s2">&quot;diagnostics&quot;</span><span class="p">,</span>
            <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span>
            <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;cached&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">created_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="n">required_dirs</span><span class="p">:</span>
            <span class="n">result_dir</span> <span class="o">=</span> <span class="n">ensure_dir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
            <span class="n">created_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_dir</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">result_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">result_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>

        <span class="c1"># Verify all directories were created</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">created_dirs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_dirs</span><span class="p">)</span>

        <span class="c1"># Test that they can be used for file operations</span>
        <span class="n">test_file</span> <span class="o">=</span> <span class="n">created_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;test.txt&quot;</span>
        <span class="n">test_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;test content&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">test_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">test_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;test content&quot;</span></div>
</div>



<div class="viewcode-block" id="TestMockedHeavyComputation">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestMockedHeavyComputation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestMockedHeavyComputation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test integration with mocked heavy computational components.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestMockedHeavyComputation.test_mock_optimization_workflow">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestMockedHeavyComputation.test_mock_optimization_workflow">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_mock_optimization_workflow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span><span class="p">,</span> <span class="n">mock_optimization_result</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test analysis workflow with mocked optimization.&quot;&quot;&quot;</span>

        <span class="c1"># Mock the heavy optimization function</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;scipy.optimize.minimize&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_minimize</span><span class="p">:</span>
            <span class="n">mock_minimize</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_optimization_result</span>

            <span class="c1"># Simulate analysis workflow</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">dummy_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_settings&quot;</span><span class="p">][</span><span class="s2">&quot;results_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;mock_opt&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Create mock analysis function</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">mock_analysis_function</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Simulate analysis with mocked optimization.&quot;&quot;&quot;</span>
                <span class="c1"># This would normally call heavy computation</span>
                <span class="c1"># Instead, we return the mocked result</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;best_parameters&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;initial_parameters&quot;</span><span class="p">][</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">],</span>
                            <span class="n">mock_optimization_result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;best_chi_squared&quot;</span><span class="p">:</span> <span class="n">mock_optimization_result</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span>
                    <span class="s2">&quot;optimization_success&quot;</span><span class="p">:</span> <span class="n">mock_optimization_result</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
                    <span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="n">mock_optimization_result</span><span class="o">.</span><span class="n">nit</span><span class="p">,</span>
                    <span class="s2">&quot;function_evaluations&quot;</span><span class="p">:</span> <span class="n">mock_optimization_result</span><span class="o">.</span><span class="n">nfev</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Run mocked analysis</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">mock_analysis_function</span><span class="p">()</span>

            <span class="c1"># Verify mock was called and results are reasonable</span>
            <span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;best_chi_squared&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mock_optimization_result</span><span class="o">.</span><span class="n">fun</span>
            <span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;optimization_success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;best_parameters&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;initial_parameters&quot;</span><span class="p">][</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Test that we can save these results</span>
            <span class="k">if</span> <span class="n">IO_UTILS_AVAILABLE</span><span class="p">:</span>
                <span class="n">save_status</span> <span class="o">=</span> <span class="n">save_analysis_results</span><span class="p">(</span>
                    <span class="n">results</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="s2">&quot;mock_optimization&quot;</span>
                <span class="p">)</span>
                <span class="k">assert</span> <span class="n">save_status</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TestMockedHeavyComputation.test_mock_data_loading">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestMockedHeavyComputation.test_mock_data_loading">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_mock_data_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test data loading workflow with mocked file I/O.&quot;&quot;&quot;</span>

        <span class="c1"># Create mock data files</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;mock_data&quot;</span>
        <span class="n">data_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

        <span class="c1"># Mock HDF5 data loading</span>
        <span class="n">mock_correlation_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
        <span class="n">mock_phi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">22.5</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">,</span> <span class="mf">67.5</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">])</span>

        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;numpy.load&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_load</span><span class="p">:</span>
            <span class="c1"># Configure mock to return our test data</span>
            <span class="n">mock_load</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;correlation_data&quot;</span><span class="p">:</span> <span class="n">mock_correlation_data</span><span class="p">,</span>
                <span class="s2">&quot;phi_angles&quot;</span><span class="p">:</span> <span class="n">mock_phi_angles</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Simulate data loading workflow</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">mock_load_data</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Simulate heavy data loading operation.&quot;&quot;&quot;</span>
                <span class="c1"># This would normally load from HDF5</span>
                <span class="n">loaded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;mock_file.npz&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;experimental_data&quot;</span><span class="p">:</span> <span class="n">loaded</span><span class="p">[</span><span class="s2">&quot;correlation_data&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;phi_angles&quot;</span><span class="p">:</span> <span class="n">loaded</span><span class="p">[</span><span class="s2">&quot;phi_angles&quot;</span><span class="p">],</span>
                <span class="p">}</span>

            <span class="c1"># Test the workflow</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">mock_load_data</span><span class="p">()</span>

            <span class="c1"># Verify mock was used and data is correct shape</span>
            <span class="n">mock_load</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;mock_file.npz&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;experimental_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">mock_correlation_data</span><span class="o">.</span><span class="n">shape</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;phi_angles&quot;</span><span class="p">],</span> <span class="n">mock_phi_angles</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestMockedHeavyComputation.test_plotting_workflow_integration">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestMockedHeavyComputation.test_plotting_workflow_integration">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span>
        <span class="ow">not</span> <span class="n">PLOTTING_AVAILABLE</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Plotting module not available&quot;</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_plotting_workflow_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test plotting workflow integration without parameter evolution.&quot;&quot;&quot;</span>

        <span class="c1"># Test that plotting works without the removed parameter evolution function</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_c2_heatmaps</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

        <span class="n">exp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="n">theory_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="n">phi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span>

        <span class="c1"># This should work with actual plotting functions</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">plot_c2_heatmaps</span><span class="p">(</span>
            <span class="n">exp_data</span><span class="p">,</span> <span class="n">theory_data</span><span class="p">,</span> <span class="n">phi_angles</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span>
        <span class="p">)</span>

        <span class="c1"># Should succeed and create plot files</span>
        <span class="k">assert</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="n">plot_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">temp_directory</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.png&quot;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></div>
</div>



<div class="viewcode-block" id="TestErrorHandlingIntegration">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestErrorHandlingIntegration">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestErrorHandlingIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test error handling across the complete workflow.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestErrorHandlingIntegration.test_partial_failure_recovery">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestErrorHandlingIntegration.test_partial_failure_recovery">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_partial_failure_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that workflow continues when some components fail.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">dummy_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_settings&quot;</span><span class="p">][</span><span class="s2">&quot;results_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;partial_failure&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create results with some missing components</span>
        <span class="n">partial_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;best_parameters&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;D0&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">},</span>
            <span class="s2">&quot;best_chi_squared&quot;</span><span class="p">:</span> <span class="mf">1.234</span><span class="p">,</span>
            <span class="c1"># Missing: experimental_data, theoretical_data (plots will fail)</span>
            <span class="s2">&quot;parameter_bounds&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;parameter_space&quot;</span><span class="p">][</span><span class="s2">&quot;bounds&quot;</span><span class="p">][:</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Save should succeed</span>
        <span class="k">if</span> <span class="n">IO_UTILS_AVAILABLE</span><span class="p">:</span>
            <span class="n">save_status</span> <span class="o">=</span> <span class="n">save_analysis_results</span><span class="p">(</span>
                <span class="n">partial_results</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="s2">&quot;partial_test&quot;</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">save_status</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>

        <span class="c1"># Plotting should handle missing data gracefully</span>
        <span class="k">if</span> <span class="n">PLOTTING_AVAILABLE</span><span class="p">:</span>
            <span class="n">plot_status</span> <span class="o">=</span> <span class="n">create_all_plots</span><span class="p">(</span>
                <span class="n">partial_results</span><span class="p">,</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;partial_failure&quot;</span><span class="p">,</span> <span class="n">config</span>
            <span class="p">)</span>

            <span class="c1"># Some plots may fail, but the function should return status</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_status</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="c1"># At least one plot type should succeed (parameter evolution)</span>
            <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">plot_status</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestErrorHandlingIntegration.test_configuration_error_handling">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestErrorHandlingIntegration.test_configuration_error_handling">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_configuration_error_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling of invalid configurations.&quot;&quot;&quot;</span>
        <span class="n">invalid_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;analyzer_parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;temporal&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="s2">&quot;start_frame&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="s2">&quot;end_frame&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="p">}</span>  <span class="c1"># Invalid values</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">config_file</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;invalid_config.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">invalid_config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="c1"># Loading should work (JSON is valid)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">loaded_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">loaded_config</span> <span class="o">==</span> <span class="n">invalid_config</span>

        <span class="c1"># But validation would catch the issues</span>
        <span class="k">assert</span> <span class="n">loaded_config</span><span class="p">[</span><span class="s2">&quot;analyzer_parameters&quot;</span><span class="p">][</span><span class="s2">&quot;temporal&quot;</span><span class="p">][</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">loaded_config</span><span class="p">[</span><span class="s2">&quot;analyzer_parameters&quot;</span><span class="p">][</span><span class="s2">&quot;temporal&quot;</span><span class="p">][</span><span class="s2">&quot;start_frame&quot;</span><span class="p">]</span>
            <span class="o">&gt;</span> <span class="n">loaded_config</span><span class="p">[</span><span class="s2">&quot;analyzer_parameters&quot;</span><span class="p">][</span><span class="s2">&quot;temporal&quot;</span><span class="p">][</span><span class="s2">&quot;end_frame&quot;</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestErrorHandlingIntegration.test_file_permission_error_handling">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestErrorHandlingIntegration.test_file_permission_error_handling">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_file_permission_error_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling of file permission errors.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>  <span class="c1"># Skip on Windows</span>
            <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Permission tests not reliable on Windows&quot;</span><span class="p">)</span>

        <span class="c1"># Create a read-only directory</span>
        <span class="n">readonly_dir</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;readonly&quot;</span>
        <span class="n">readonly_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mo">0o444</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Attempt to save results should fail gracefully</span>
            <span class="k">if</span> <span class="n">IO_UTILS_AVAILABLE</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">}</span>
                <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;output_settings&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;results_directory&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">readonly_dir</span><span class="p">)}</span>
                <span class="p">}</span>

                <span class="n">save_status</span> <span class="o">=</span> <span class="n">save_analysis_results</span><span class="p">(</span>
                    <span class="n">results</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="s2">&quot;permission_test&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Should handle permission error gracefully</span>
                <span class="k">assert</span> <span class="n">save_status</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Clean up</span>
            <span class="n">readonly_dir</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="mo">0o755</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestDataValidation">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestDataValidation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestDataValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test data validation throughout the workflow.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestDataValidation.test_correlation_data_validation">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestDataValidation.test_correlation_data_validation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_correlation_data_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy_phi_angles</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test validation of correlation data shapes and values.&quot;&quot;&quot;</span>

        <span class="c1"># Valid data</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span>
            <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span>
        <span class="p">)</span>  <span class="c1"># angles x t2 x t1</span>
        <span class="k">assert</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_phi_angles</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">valid_data</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">valid_data</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="p">)</span>  <span class="c1"># Correlation data should be non-negative</span>

        <span class="c1"># Invalid data shapes</span>
        <span class="n">wrong_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>  <span class="c1"># Too many angles</span>
        <span class="k">assert</span> <span class="n">wrong_angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_phi_angles</span><span class="p">)</span>

        <span class="n">wrong_dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span>
            <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span>
        <span class="p">)</span>  <span class="c1"># Missing delay time dimension</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrong_dimensions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span>

        <span class="c1"># Invalid data values</span>
        <span class="n">nan_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">nan_data</span><span class="p">))</span>

        <span class="n">negative_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">negative_data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestDataValidation.test_parameter_bounds_validation">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestDataValidation.test_parameter_bounds_validation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_parameter_bounds_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test parameter bounds validation.&quot;&quot;&quot;</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">dummy_config</span><span class="p">[</span><span class="s2">&quot;parameter_space&quot;</span><span class="p">][</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">:</span>
            <span class="c1"># Check required fields</span>
            <span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">bound</span>
            <span class="k">assert</span> <span class="s2">&quot;min&quot;</span> <span class="ow">in</span> <span class="n">bound</span>
            <span class="k">assert</span> <span class="s2">&quot;max&quot;</span> <span class="ow">in</span> <span class="n">bound</span>

            <span class="c1"># Check logical consistency</span>
            <span class="k">assert</span> <span class="n">bound</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bound</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>

            <span class="c1"># Check physical constraints for specific parameters</span>
            <span class="k">if</span> <span class="n">bound</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;D0&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma_dot_t0&quot;</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="p">(</span>
                    <span class="n">bound</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bound</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> must have positive minimum&quot;</span>

            <span class="c1"># Check that bounds are reasonable</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestDataValidation.test_time_array_validation">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestDataValidation.test_time_array_validation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_time_array_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test validation of time arrays.&quot;&quot;&quot;</span>
        <span class="c1"># Valid time arrays</span>
        <span class="n">valid_t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">valid_t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">valid_t2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">valid_t1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_t2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_t1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">30</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">valid_t2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Should be increasing</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">valid_t1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Invalid time arrays</span>
        <span class="n">negative_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">negative_times</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">non_monotonic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">non_monotonic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestMemoryManagement">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestMemoryManagement">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestMemoryManagement</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test memory-efficient operations and cleanup.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestMemoryManagement.test_large_array_handling">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestMemoryManagement.test_large_array_handling">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_large_array_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling of large data arrays without excessive memory usage.&quot;&quot;&quot;</span>
        <span class="c1"># Create moderately large arrays to test memory handling</span>
        <span class="n">large_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>  <span class="c1"># Still manageable in CI environments</span>

        <span class="c1"># Use numpy&#39;s memory mapping capabilities for large arrays</span>
        <span class="n">large_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">large_shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="p">)</span>  <span class="c1"># Use float32 to save memory</span>

        <span class="c1"># Test that we can process the data</span>
        <span class="k">assert</span> <span class="n">large_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">large_shape</span>
        <span class="k">assert</span> <span class="n">large_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

        <span class="c1"># Test basic operations that shouldn&#39;t cause memory issues</span>
        <span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">large_data</span><span class="p">)</span>
        <span class="n">std_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">large_data</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mean_val</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">std_val</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">std_val</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Test saving large arrays</span>
        <span class="k">if</span> <span class="n">IO_UTILS_AVAILABLE</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.core.io_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_numpy</span>

            <span class="n">filepath</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;large_array.npz&quot;</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">save_numpy</span><span class="p">(</span><span class="n">large_data</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="n">filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

            <span class="c1"># Verify we can load it back</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">loaded</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">large_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestMemoryManagement.test_cleanup_after_plotting">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestMemoryManagement.test_cleanup_after_plotting">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_cleanup_after_plotting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that matplotlib figures are properly cleaned up.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">initial_figs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">get_fignums</span><span class="p">())</span>

        <span class="c1"># Create and save a plot</span>
        <span class="k">if</span> <span class="n">PLOTTING_AVAILABLE</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_c2_heatmaps</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

            <span class="n">exp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.0</span>
            <span class="n">theory_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.0</span>
            <span class="n">phi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span>

            <span class="n">success</span> <span class="o">=</span> <span class="n">plot_c2_heatmaps</span><span class="p">(</span>
                <span class="n">exp_data</span><span class="p">,</span> <span class="n">theory_data</span><span class="p">,</span> <span class="n">phi_angles</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span>
            <span class="p">)</span>

            <span class="c1"># Check that figures were cleaned up</span>
            <span class="n">final_figs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">get_fignums</span><span class="p">())</span>

            <span class="c1"># Should not accumulate figures (memory leak prevention)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">final_figs</span> <span class="o">&lt;=</span> <span class="n">initial_figs</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>  <span class="c1"># Allow for one figure that might remain</span></div>
</div>



<div class="viewcode-block" id="TestPerAngleAnalysisIntegration">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestPerAngleAnalysisIntegration">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestPerAngleAnalysisIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration tests for per-angle chi-squared analysis.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestPerAngleAnalysisIntegration.test_per_angle_analysis_with_quality_assessment">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestPerAngleAnalysisIntegration.test_per_angle_analysis_with_quality_assessment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_per_angle_analysis_with_quality_assessment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test per-angle analysis integration with quality assessment.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

        <span class="c1"># Add fit_quality rules to config if not present</span>
        <span class="k">if</span> <span class="s2">&quot;validation_rules&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dummy_config</span><span class="p">:</span>
            <span class="n">dummy_config</span><span class="p">[</span><span class="s2">&quot;validation_rules&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">dummy_config</span><span class="p">[</span><span class="s2">&quot;validation_rules&quot;</span><span class="p">][</span><span class="s2">&quot;fit_quality&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;overall_chi_squared&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;excellent_threshold&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;acceptable_threshold&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
                <span class="s2">&quot;warning_threshold&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
                <span class="s2">&quot;critical_threshold&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;per_angle_chi_squared&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;excellent_threshold&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;acceptable_threshold&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
                <span class="s2">&quot;warning_threshold&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
                <span class="s2">&quot;outlier_threshold_multiplier&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
                <span class="s2">&quot;max_outlier_fraction&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
                <span class="s2">&quot;min_good_angles&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Mock analyzer with per-angle analysis capability</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
            <span class="s2">&quot;homodyne.analysis.core.HomodyneAnalysisCore&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">MockAnalyzer</span><span class="p">:</span>
            <span class="n">mock_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
            <span class="n">MockAnalyzer</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_instance</span>
            <span class="n">mock_instance</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">dummy_config</span>

            <span class="c1"># Mock per-angle analysis method</span>
            <span class="n">mock_instance</span><span class="o">.</span><span class="n">analyze_per_angle_chi_squared</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;TestMethod&quot;</span><span class="p">,</span>
                <span class="s2">&quot;overall_reduced_chi_squared&quot;</span><span class="p">:</span> <span class="mf">25.0</span><span class="p">,</span>
                <span class="s2">&quot;overall_reduced_chi_squared_uncertainty&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
                <span class="s2">&quot;overall_reduced_chi_squared_std&quot;</span><span class="p">:</span> <span class="mf">5.5</span><span class="p">,</span>
                <span class="s2">&quot;n_optimization_angles&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s2">&quot;quality_assessment&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;overall_quality&quot;</span><span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;per_angle_quality&quot;</span><span class="p">:</span> <span class="s2">&quot;acceptable&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;combined_quality&quot;</span><span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;quality_issues&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Overall chi-squared above warning threshold&quot;</span>
                    <span class="p">],</span>
                <span class="p">},</span>
                <span class="s2">&quot;angle_categorization&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;good_angles&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
                    <span class="s2">&quot;unacceptable_angles&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
                    <span class="s2">&quot;statistical_outliers&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="c1"># Test analysis execution</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1000.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
            <span class="n">phi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">70.0</span><span class="p">,</span> <span class="mf">80.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">c2_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">mock_instance</span><span class="o">.</span><span class="n">analyze_per_angle_chi_squared</span><span class="p">(</span>
                <span class="n">parameters</span><span class="p">,</span>
                <span class="n">phi_angles</span><span class="p">,</span>
                <span class="n">c2_exp</span><span class="p">,</span>
                <span class="n">save_to_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">temp_directory</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Verify analysis was called</span>
            <span class="n">mock_instance</span><span class="o">.</span><span class="n">analyze_per_angle_chi_squared</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

            <span class="c1"># Verify quality assessment structure</span>
            <span class="k">assert</span> <span class="s2">&quot;quality_assessment&quot;</span> <span class="ow">in</span> <span class="n">result</span>
            <span class="k">assert</span> <span class="s2">&quot;angle_categorization&quot;</span> <span class="ow">in</span> <span class="n">result</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;quality_assessment&quot;</span><span class="p">][</span><span class="s2">&quot;combined_quality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="TestPerAngleAnalysisIntegration.test_per_angle_file_output_integration">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestPerAngleAnalysisIntegration.test_per_angle_file_output_integration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_per_angle_file_output_integration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that per-angle results are properly saved to files.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

        <span class="c1"># Create mock results that would be saved</span>
        <span class="n">mock_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;Classical&quot;</span><span class="p">,</span>
            <span class="s2">&quot;overall_reduced_chi_squared&quot;</span><span class="p">:</span> <span class="mf">15.0</span><span class="p">,</span>
            <span class="s2">&quot;overall_reduced_chi_squared_uncertainty&quot;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span>
            <span class="s2">&quot;overall_reduced_chi_squared_std&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
            <span class="s2">&quot;n_optimization_angles&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;per_angle_analysis&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;phi_angles_deg&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">],</span>
                <span class="s2">&quot;chi_squared_reduced&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;quality_assessment&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;combined_quality&quot;</span><span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
                <span class="s2">&quot;thresholds_used&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;acceptable_per_angle&quot;</span><span class="p">:</span> <span class="mf">15.0</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;angle_categorization&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;good_angles&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;angles_deg&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">]},</span>
                <span class="s2">&quot;unacceptable_angles&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="s2">&quot;angles_deg&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Mock file saving by creating the expected file manually</span>
        <span class="n">results_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">temp_directory</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;per_angle_chi_squared_classical.json&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">mock_results</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Verify file was created and contains expected data</span>
        <span class="k">assert</span> <span class="n">results_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">saved_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">saved_data</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Classical&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;quality_assessment&quot;</span> <span class="ow">in</span> <span class="n">saved_data</span>
        <span class="k">assert</span> <span class="s2">&quot;angle_categorization&quot;</span> <span class="ow">in</span> <span class="n">saved_data</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s2">&quot;per_angle_analysis&quot;</span><span class="p">][</span><span class="s2">&quot;phi_angles_deg&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">5</span></div>
</div>



<div class="viewcode-block" id="TestConcurrencyAndRaceConditions">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestConcurrencyAndRaceConditions">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestConcurrencyAndRaceConditions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test handling of concurrent operations and race conditions.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestConcurrencyAndRaceConditions.test_concurrent_directory_creation">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestConcurrencyAndRaceConditions.test_concurrent_directory_creation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_concurrent_directory_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that concurrent directory creation is handled safely.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;concurrent_test&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">create_directory</span><span class="p">(</span><span class="n">subdir_name</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Function to create directory in thread.&quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">ensure_dir</span><span class="p">(</span><span class="n">base_dir</span> <span class="o">/</span> <span class="n">subdir_name</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Create multiple directories concurrently</span>
        <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;subdir_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">create_directory</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span> <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">subdirs</span>
            <span class="p">]</span>

            <span class="c1"># Wait for all to complete</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
                <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Check that all directories were created</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Errors occurred: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdirs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">subdirs</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">base_dir</span> <span class="o">/</span> <span class="n">subdir</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestConcurrencyAndRaceConditions.test_concurrent_file_saving">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestConcurrencyAndRaceConditions.test_concurrent_file_saving">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_concurrent_file_saving</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test concurrent file saving operations.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">IO_UTILS_AVAILABLE</span><span class="p">:</span>
            <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;IO utils not available&quot;</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.core.io_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_json</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">save_test_file</span><span class="p">(</span><span class="n">file_id</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Function to save file in thread.&quot;&quot;&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">file_id</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">file_id</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))}</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;concurrent_file_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">.json&quot;</span>
            <span class="k">return</span> <span class="n">save_json</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>

        <span class="c1"># Save multiple files concurrently</span>
        <span class="n">file_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">save_test_file</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span> <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">file_ids</span>
            <span class="p">]</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>

        <span class="c1"># All saves should succeed</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># Verify all files exist and have correct content</span>
        <span class="k">for</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="n">file_ids</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;concurrent_file_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">.json&quot;</span>
            <span class="k">assert</span> <span class="n">filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">file_id</span>
            <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">file_id</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="TestAnalysisWorkflowIntegration">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestAnalysisWorkflowIntegration">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestAnalysisWorkflowIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test integration of analysis workflow with plotting.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestAnalysisWorkflowIntegration.test_analysis_plotting_integration">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestAnalysisWorkflowIntegration.test_analysis_plotting_integration">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span>
        <span class="ow">not</span> <span class="n">CORE_ANALYSIS_AVAILABLE</span><span class="p">,</span>
        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Core analysis module not available&quot;</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_analysis_plotting_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that analysis workflow integrates properly with plotting.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.tests.fixtures</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_minimal_config_file</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">create_minimal_config_file</span><span class="p">(</span><span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;test_config.json&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Initialize analyzer</span>
            <span class="n">analyzer</span> <span class="o">=</span> <span class="n">HomodyneAnalysisCore</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
            
            <span class="c1"># Check that analyzer has plotting methods</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="s1">&#39;_generate_analysis_plots&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="s1">&#39;_prepare_plot_data&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="s1">&#39;_generate_theoretical_data&#39;</span><span class="p">)</span>
            
            <span class="c1"># Check cache variables are initialized</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="s1">&#39;_last_experimental_data&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="s1">&#39;_last_phi_angles&#39;</span><span class="p">)</span>
            
            <span class="c1"># Simulate analysis results</span>
            <span class="n">mock_results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;classical_optimization&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
                    <span class="s1">&#39;chi_squared&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="c1"># Test plot data preparation</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">_prepare_plot_data</span><span class="p">(</span><span class="n">mock_results</span><span class="p">,</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">plot_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="s1">&#39;best_parameters&#39;</span> <span class="ow">in</span> <span class="n">plot_data</span>
            <span class="k">assert</span> <span class="s1">&#39;parameter_bounds&#39;</span> <span class="ow">in</span> <span class="n">plot_data</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Configuration file not found&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Could not create valid config file for test&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="TestAnalysisWorkflowIntegration.test_mcmc_results_plotting_integration">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestAnalysisWorkflowIntegration.test_mcmc_results_plotting_integration">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span>
        <span class="ow">not</span> <span class="p">(</span><span class="n">CORE_ANALYSIS_AVAILABLE</span> <span class="ow">and</span> <span class="n">PLOTTING_AVAILABLE</span><span class="p">),</span>
        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Core analysis or plotting not available&quot;</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_mcmc_results_plotting_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test MCMC results integration with plotting workflow.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.tests.fixtures</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_minimal_config_file</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">create_minimal_config_file</span><span class="p">(</span><span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;mcmc_test_config.json&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">arviz</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">az</span>
            
            <span class="n">analyzer</span> <span class="o">=</span> <span class="n">HomodyneAnalysisCore</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
            
            <span class="c1"># Create mock MCMC results with trace data</span>
            <span class="n">n_chains</span><span class="p">,</span> <span class="n">n_draws</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span>
            <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;D0&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;D_offset&quot;</span><span class="p">]</span>
            
            <span class="n">posterior_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
                <span class="n">posterior_dict</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">n_chains</span><span class="p">,</span> <span class="n">n_draws</span><span class="p">))</span>
            
            <span class="n">trace_data</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">&quot;posterior&quot;</span><span class="p">:</span> <span class="n">posterior_dict</span><span class="p">})</span>
            
            <span class="n">mcmc_results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;mcmc_optimization&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
                    <span class="s1">&#39;chi_squared&#39;</span><span class="p">:</span> <span class="mf">2.3</span><span class="p">,</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;convergence_diagnostics&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;max_rhat&#39;</span><span class="p">:</span> <span class="mf">1.05</span><span class="p">,</span>
                        <span class="s1">&#39;min_ess&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                        <span class="s1">&#39;converged&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="c1"># Updated to match actual MCMC module output format</span>
                        <span class="s1">&#39;rhat&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;D0&#39;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">1.03</span><span class="p">,</span> <span class="s1">&#39;D_offset&#39;</span><span class="p">:</span> <span class="mf">1.01</span><span class="p">},</span>
                        <span class="s1">&#39;ess&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;D0&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span> <span class="s1">&#39;D_offset&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">},</span>
                        <span class="s1">&#39;mcse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;D0&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span> <span class="s1">&#39;D_offset&#39;</span><span class="p">:</span> <span class="mf">0.0015</span><span class="p">},</span>
                        <span class="c1"># Keep backward compatibility with old format too</span>
                        <span class="s1">&#39;r_hat&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;D0&#39;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">1.03</span><span class="p">,</span> <span class="s1">&#39;D_offset&#39;</span><span class="p">:</span> <span class="mf">1.01</span><span class="p">},</span>
                        <span class="s1">&#39;ess_bulk&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;D0&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span> <span class="s1">&#39;D_offset&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">},</span>
                        <span class="s1">&#39;mcse_mean&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;D0&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span> <span class="s1">&#39;D_offset&#39;</span><span class="p">:</span> <span class="mf">0.0015</span><span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="c1"># Test MCMC plot data preparation</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">_prepare_plot_data</span><span class="p">(</span><span class="n">mcmc_results</span><span class="p">,</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">plot_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="s1">&#39;mcmc_diagnostics&#39;</span> <span class="ow">in</span> <span class="n">plot_data</span>
            <span class="k">assert</span> <span class="s1">&#39;parameter_names&#39;</span> <span class="ow">in</span> <span class="n">plot_data</span>
            <span class="k">assert</span> <span class="s1">&#39;parameter_units&#39;</span> <span class="ow">in</span> <span class="n">plot_data</span>
            
            <span class="c1"># Add mock trace data to plot_data and test plotting</span>
            <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;mcmc_trace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_data</span>
            
            <span class="c1"># Test individual MCMC plotting functions</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">plot_mcmc_corner</span><span class="p">,</span> <span class="n">plot_mcmc_trace</span><span class="p">,</span> <span class="n">plot_mcmc_convergence_diagnostics</span>
            <span class="p">)</span>
            
            <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;mcmc_plots&quot;</span>
            <span class="n">plots_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Test corner plot</span>
            <span class="n">corner_success</span> <span class="o">=</span> <span class="n">plot_mcmc_corner</span><span class="p">(</span>
                <span class="n">trace_data</span><span class="p">,</span> <span class="n">plots_dir</span><span class="p">,</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">param_names</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span>
                <span class="n">param_units</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Å²/s&quot;</span><span class="p">,</span> <span class="s2">&quot;dimensionless&quot;</span><span class="p">,</span> <span class="s2">&quot;Å²/s&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            
            <span class="c1"># Test trace plot</span>
            <span class="n">trace_success</span> <span class="o">=</span> <span class="n">plot_mcmc_trace</span><span class="p">(</span>
                <span class="n">trace_data</span><span class="p">,</span> <span class="n">plots_dir</span><span class="p">,</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">param_names</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span>
                <span class="n">param_units</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Å²/s&quot;</span><span class="p">,</span> <span class="s2">&quot;dimensionless&quot;</span><span class="p">,</span> <span class="s2">&quot;Å²/s&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            
            <span class="c1"># Test convergence diagnostics</span>
            <span class="n">diag_success</span> <span class="o">=</span> <span class="n">plot_mcmc_convergence_diagnostics</span><span class="p">(</span>
                <span class="n">trace_data</span><span class="p">,</span> 
                <span class="n">mcmc_results</span><span class="p">[</span><span class="s1">&#39;mcmc_optimization&#39;</span><span class="p">][</span><span class="s1">&#39;convergence_diagnostics&#39;</span><span class="p">],</span>
                <span class="n">plots_dir</span><span class="p">,</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">param_names</span><span class="o">=</span><span class="n">param_names</span>
            <span class="p">)</span>
            
            <span class="c1"># At least one plot should succeed (depending on available packages)</span>
            <span class="k">assert</span> <span class="nb">any</span><span class="p">([</span><span class="n">corner_success</span><span class="p">,</span> <span class="n">trace_success</span><span class="p">,</span> <span class="n">diag_success</span><span class="p">])</span>
            
            <span class="c1"># Check for created files</span>
            <span class="n">plot_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plots_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.png&quot;</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;ArviZ not available for MCMC integration test&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Configuration file not found&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Could not create valid config file for test&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="TestAnalysisWorkflowIntegration.test_configuration_consistency_integration">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestAnalysisWorkflowIntegration.test_configuration_consistency_integration">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span>
        <span class="ow">not</span> <span class="n">CORE_ANALYSIS_AVAILABLE</span><span class="p">,</span>
        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Core analysis module not available&quot;</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_configuration_consistency_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that configuration is consistent across analysis workflow.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">homodyne.tests.fixtures</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_minimal_config_file</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">create_minimal_config_file</span><span class="p">(</span><span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;consistency_test_config.json&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">analyzer</span> <span class="o">=</span> <span class="n">HomodyneAnalysisCore</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
            
            <span class="c1"># Check parameter consistency</span>
            <span class="n">param_names</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_parameters&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parameter_names&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">param_values</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_parameters&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parameter_space&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bounds&#39;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="c1"># All should have same count</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
            
            <span class="c1"># Parameter names should match between initial parameters and bounds</span>
            <span class="n">bound_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">bound</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">param_names</span> <span class="o">==</span> <span class="n">bound_names</span>
            
            <span class="c1"># Check plotting configuration</span>
            <span class="n">output_settings</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_settings&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">reporting</span> <span class="o">=</span> <span class="n">output_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reporting&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">plotting_enabled</span> <span class="o">=</span> <span class="n">reporting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;generate_plots&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># Should have valid plotting configuration</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plotting_enabled</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">plotting_enabled</span><span class="p">:</span>
                <span class="n">plot_formats</span> <span class="o">=</span> <span class="n">reporting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_formats&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_formats</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_formats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                
                <span class="c1"># All formats should be valid</span>
                <span class="n">valid_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;svg&#39;</span><span class="p">,</span> <span class="s1">&#39;eps&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">fmt</span> <span class="ow">in</span> <span class="n">valid_formats</span> <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="n">plot_formats</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Configuration file not found&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Could not create valid config file for test&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="TestAnalysisWorkflowIntegration.test_end_to_end_plotting_workflow">
<a class="viewcode-back" href="../../../api/homodyne.tests.html#homodyne.tests.test_integration.TestAnalysisWorkflowIntegration.test_end_to_end_plotting_workflow">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_end_to_end_plotting_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_directory</span><span class="p">,</span> <span class="n">dummy_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test complete end-to-end plotting workflow.&quot;&quot;&quot;</span>
        <span class="c1"># Set up comprehensive mock results with all plot types</span>
        <span class="n">comprehensive_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;experimental_data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;theoretical_data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;phi_angles&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">90</span><span class="p">]),</span>
            <span class="s2">&quot;best_parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;D0&quot;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">,</span>
                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;D_offset&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
                <span class="s2">&quot;gamma_dot_t0&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
                <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="s2">&quot;gamma_dot_t_offset&quot;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">,</span>
                <span class="s2">&quot;phi0&quot;</span><span class="p">:</span> <span class="mf">5.0</span>
            <span class="p">},</span>
            <span class="s2">&quot;parameter_bounds&quot;</span><span class="p">:</span> <span class="n">dummy_config</span><span class="p">[</span><span class="s2">&quot;parameter_space&quot;</span><span class="p">][</span><span class="s2">&quot;bounds&quot;</span><span class="p">],</span>
            <span class="s2">&quot;parameter_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D0&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;D_offset&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma_dot_t0&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma_dot_t_offset&quot;</span><span class="p">,</span> <span class="s2">&quot;phi0&quot;</span><span class="p">],</span>
            <span class="s2">&quot;parameter_units&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Å²/s&quot;</span><span class="p">,</span> <span class="s2">&quot;dimensionless&quot;</span><span class="p">,</span> <span class="s2">&quot;Å²/s&quot;</span><span class="p">,</span> <span class="s2">&quot;s⁻¹&quot;</span><span class="p">,</span> <span class="s2">&quot;dimensionless&quot;</span><span class="p">,</span> <span class="s2">&quot;s⁻¹&quot;</span><span class="p">,</span> <span class="s2">&quot;degrees&quot;</span><span class="p">],</span>
            <span class="s2">&quot;chi_squared&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;Comprehensive Test&quot;</span>
        <span class="p">}</span>
        
        <span class="c1"># Add MCMC data if ArviZ is available</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">arviz</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">az</span>
            
            <span class="n">n_chains</span><span class="p">,</span> <span class="n">n_draws</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">200</span>
            <span class="n">param_names</span> <span class="o">=</span> <span class="n">comprehensive_results</span><span class="p">[</span><span class="s2">&quot;parameter_names&quot;</span><span class="p">]</span>
            
            <span class="n">posterior_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;D0&quot;</span><span class="p">:</span>
                    <span class="n">posterior_dict</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="n">n_chains</span><span class="p">,</span> <span class="n">n_draws</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">posterior_dict</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="p">(</span><span class="n">n_chains</span><span class="p">,</span> <span class="n">n_draws</span><span class="p">))</span>

            <span class="n">trace_data</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">&quot;posterior&quot;</span><span class="p">:</span> <span class="n">posterior_dict</span><span class="p">})</span>
            
            <span class="n">comprehensive_results</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s2">&quot;mcmc_trace&quot;</span><span class="p">:</span> <span class="n">trace_data</span><span class="p">,</span>
                <span class="s2">&quot;mcmc_diagnostics&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;r_hat&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">},</span>
                    <span class="s2">&quot;ess_bulk&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">},</span>
                    <span class="s2">&quot;mcse_mean&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">},</span>
                    <span class="s2">&quot;max_rhat&quot;</span><span class="p">:</span> <span class="mf">1.08</span><span class="p">,</span>
                    <span class="s2">&quot;min_ess&quot;</span><span class="p">:</span> <span class="mi">180</span><span class="p">,</span>
                    <span class="s2">&quot;converged&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;assessment&quot;</span><span class="p">:</span> <span class="s2">&quot;Good&quot;</span>
                <span class="p">}</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Skip MCMC parts if ArviZ not available</span>
        
        <span class="c1"># Test plotting workflow</span>
        <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">temp_directory</span> <span class="o">/</span> <span class="s2">&quot;comprehensive_plots&quot;</span>
        <span class="n">plots_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">plot_status</span> <span class="o">=</span> <span class="n">create_all_plots</span><span class="p">(</span><span class="n">comprehensive_results</span><span class="p">,</span> <span class="n">plots_dir</span><span class="p">,</span> <span class="n">dummy_config</span><span class="p">)</span>
        
        <span class="c1"># Check results</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_status</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        
        <span class="c1"># Should have attempted multiple plot types</span>
        <span class="n">expected_basic_plots</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c2_heatmaps&quot;</span><span class="p">,</span> <span class="s2">&quot;diagnostic_summary&quot;</span><span class="p">]</span>
        <span class="c1"># parameter_evolution has been removed due to persistent issues</span>
        <span class="k">for</span> <span class="n">plot_type</span> <span class="ow">in</span> <span class="n">expected_basic_plots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_type</span> <span class="ow">in</span> <span class="n">plot_status</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_status</span><span class="p">[</span><span class="n">plot_type</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
        
        <span class="c1"># Check that files were created</span>
        <span class="n">all_plot_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plots_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.png&quot;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_plot_files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>  <span class="c1"># Should create multiple plots</span>
        
        <span class="c1"># Verify file sizes (should contain actual plot data)</span>
        <span class="k">for</span> <span class="n">plot_file</span> <span class="ow">in</span> <span class="n">all_plot_files</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">plot_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="mi">5000</span>  <span class="c1"># Reasonable minimum for plot file</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Wei Chen, Hongrui He.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>